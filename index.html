<!DOCTYPE html>
<html>
<head>
 <base target="_top">
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>ãµã‚Šè¿”ã‚Šã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</title>
 <!-- Webãƒ•ã‚©ãƒ³ãƒˆï¼ˆUDãƒ‡ã‚¸ã‚¿ãƒ«æ•™ç§‘æ›¸ä½“ãªã©ï¼‰ã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã®è¨­å®š -->
 <link rel="preconnect" href="https://fonts.googleapis.com">
 <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
 <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@300;400;500&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">

  <!-- CSSï¼ˆãƒšãƒ¼ã‚¸ã®è¦‹ãŸç›®ã‚’å®šç¾©ï¼‰ -->
  <style>
   /* --- å¤‰æ•°å®šç¾© --- */
   /* è‰²ã‚„ãƒ•ã‚©ãƒ³ãƒˆãªã©ã‚’å¤‰æ•°ã¨ã—ã¦å®šç¾©ã—ã€ã‚µã‚¤ãƒˆå…¨ä½“ã§çµ±ä¸€æ„Ÿã‚’å‡ºã™ */
   :root {
     --main-bg-color: #fdfaf4; /* ãƒ¡ã‚¤ãƒ³ã®èƒŒæ™¯è‰² */
     --notebook-bg-color: #ffffff; /* ãƒãƒ¼ãƒˆã®èƒŒæ™¯è‰² */
     --notebook-line-color: #e0e0e0; /* ãƒãƒ¼ãƒˆã®ç½«ç·šã®è‰² */
     --font-color: #333333; /* åŸºæœ¬ã®æ–‡å­—è‰² */
     --accent-color: #ff9800; /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ï¼ˆå…ç«¥ç”¨ï¼‰ */
     --teacher-accent-color: #4CAF50; /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ï¼ˆæ•™å¸«ç”¨ï¼‰ */
     --teacher-pen-color: #E53935; /* å…ˆç”Ÿã®èµ¤ãƒšãƒ³ã®è‰² */
     --highlight-color: rgba(255, 236, 179, 0.6); /* ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒãƒ¼ã‚«ãƒ¼ã®è‰² */
     --font-family: 'Kiwi Maru', serif; /* åŸºæœ¬ã®ãƒ•ã‚©ãƒ³ãƒˆ */
   }
  
   /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
   /* ã‚µã‚¤ãƒˆå…¨ä½“ã®åŸºæœ¬çš„ãªã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š */
   html, body {
     height: 100%; /* ç”»é¢ã®é«˜ã•ã„ã£ã±ã„ã«è¡¨ç¤º */
     margin: 0;
     overflow: hidden; /* ãƒšãƒ¼ã‚¸å…¨ä½“ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ */
   }

   body {
     padding: 1rem;
     box-sizing: border-box; /* paddingã‚’å«ã‚ã¦å…¨ä½“ã®ã‚µã‚¤ã‚ºã‚’è¨ˆç®— */
     display: flex;
     flex-direction: column;
     font-family: var(--font-family);
     background-color: var(--main-bg-color);
     color: var(--font-color);
   }

   h1, h2, h3, h4 {
     font-family: 'Zen Maru Gothic', sans-serif;
     font-weight: 700;
   }

   button, input[type="submit"] {
     font-family: var(--font-family);
     cursor: pointer;
     border: none;
     border-radius: 8px;
     padding: 10px 20px;
     font-size: 1em;
     background-color: var(--accent-color);
     color: white;
     transition: background-color 0.3s, transform 0.1s; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ */
     box-shadow: 0 2px 4px rgba(0,0,0,0.1);
   }
  
   button:hover, input[type="submit"]:hover {
     background-color: #fb8c00; /* ãƒã‚¦ã‚¹ã‚’ä¹—ã›ãŸæ™‚ã®è‰² */
   }

   button:active {
     transform: translateY(1px); /* ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã«å°‘ã—æ²ˆã‚€åŠ¹æœ */
   }

   rt { /* ãµã‚ŠãŒãªã®ã‚¹ã‚¿ã‚¤ãƒ« */
     font-size: 0.6em;
   }

   /* --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
   /* ç”»é¢ã®ä¸»è¦ãªè¦ç´ ã®é…ç½®ã«é–¢ã™ã‚‹è¨­å®š */
   .container {
     max-width: 1200px;
     margin: 0 auto; /* ä¸­å¤®æƒãˆ */
     width: 100%;
     display: flex;
     flex-direction: column;
     height: 100%;
   }

   main {
     flex-grow: 1; /* mainè¦ç´ ãŒæ®‹ã‚Šã®é«˜ã•ã‚’ã™ã¹ã¦ä½¿ã† */
     display: flex;
     flex-direction: column;
     min-height: 0; /* flexã‚³ãƒ³ãƒ†ãƒŠå†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«é‡è¦ */
   }

   /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
   .header {
     display: flex;
     justify-content: space-between;
     align-items: center;
     margin-bottom: 1.5rem;
     padding-bottom: 1rem;
     border-bottom: 2px solid var(--accent-color);
     flex-shrink: 0; /* ãƒ˜ãƒƒãƒ€ãƒ¼ãŒç¸®ã¾ãªã„ã‚ˆã†ã« */
   }
  
   .header-title {
     font-size: 2rem;
     margin: 0;
     color: var(--accent-color);
   }
  
   .user-info {
     text-align: right;
   }

   /* --- ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
   #notebook-view {
     flex-grow: 1;
     display: flex;
     flex-direction: column;
   }

   /* B5ãƒãƒ¼ãƒˆãƒ‡ã‚¶ã‚¤ãƒ³ */
   .notebook-container {
     flex-grow: 1;
     min-height: 0;
     display: flex;
     gap: 20px;
     width: 100%;
     background-color: #F3E9DD; /* ãƒãƒ¼ãƒˆã‚’ç½®ãæœºã®èƒŒæ™¯è‰² */
     padding: 20px;
     box-sizing: border-box;
     border-radius: 10px;
     box-shadow: 0 4px 15px rgba(0,0,0,0.1);
     flex-wrap: nowrap; /* ç¸¦ã«ä¼¸ã³ã‚‹ã®ã§æŠ˜ã‚Šè¿”ã—ã¯ä¸è¦ */
   }

   .notebook-page {
     flex: 1; /* å·¦å³ã®ãƒšãƒ¼ã‚¸ãŒå‡ç­‰ã«åºƒãŒã‚‹ */
     min-width: 300px;
     background-color: var(--notebook-bg-color);
     border: 1px solid #ccc;
     padding: 2rem;
     display: flex;
     flex-direction: column;
     position: relative;
     overflow-y: auto; 
   }
  
   .page-left { 
     border-right: 2px dashed #ccc; /* ãƒãƒ¼ãƒˆã®ä¸­å¿ƒã®ç‚¹ç·š */
   }

   #journal-content, .journal-content-display {
     flex-grow: 1; /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ãŒãƒšãƒ¼ã‚¸ã®æ®‹ã‚Šã®é«˜ã•ã‚’ã™ã¹ã¦ä½¿ã† */
     font-family: var(--font-family);
     font-size: 1.2rem;
     line-height: 2.5; /* è¡Œã®é«˜ã• */
     border: none;
     outline: none;
     resize: none; /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚µã‚¤ã‚ºå¤‰æ›´ã‚’ç¦æ­¢ */
     background-image: linear-gradient(to bottom, transparent 96%, var(--notebook-line-color) 98%); /* ç½«ç·š */
     background-size: 100% 2.5em;
     background-attachment: local; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚ç½«ç·šãŒãšã‚Œãªã„ã‚ˆã†ã« */
     padding: 0;
     white-space: pre-wrap; /* æ”¹è¡Œã‚’ãã®ã¾ã¾è¡¨ç¤º */
     min-height: 200px; 
   }
   
   .journal-image {
      cursor: pointer;
      transition: transform 0.2s;
   }
   .journal-image:hover {
      transform: scale(1.05);
   }


   /* --- å…ç«¥ç”»é¢ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ --- */
   .theme-display {
     margin-bottom: 1rem;
     padding-bottom: 0.5rem;
     border-bottom: 2px solid var(--accent-color);
   }
  
   .emotion-stamps, .support-tools {
     margin-top: 1rem;
   }
  
   .emotion-stamps button, .support-tools button {
     margin: 5px;
     font-size: 0.9em;
     padding: 8px 12px;
   }
  
   .emotion-stamps button.selected {
     background-color: #e65100; /* é¸æŠã•ã‚ŒãŸæ°—æŒã¡ãƒœã‚¿ãƒ³ã®è‰² */
     box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
   }

   /* å…ç«¥ç”»é¢ã®ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
   .view-switcher {
     margin-bottom: 1.5rem;
     text-align: center;
     flex-shrink: 0; /* ã‚¿ãƒ–ãŒç¸®ã¾ãªã„ã‚ˆã†ã« */
   }

   .view-switcher button {
     padding: 10px 25px;
     font-size: 1.1em;
     background-color: #e0e0e0;
     color: #333;
   }

   .view-switcher button.active {
     background-color: var(--accent-color);
     color: white;
   }

   .view-content.hidden {
     display: none !important; /* hiddenã‚¯ãƒ©ã‚¹ãŒã¤ã„ãŸè¦ç´ ã‚’éè¡¨ç¤º */
   }

   /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
   .calendar-container {
     padding: 1.5rem;
     background-color: white;
     border-radius: 8px;
     box-shadow: 0 2px 8px rgba(0,0,0,0.1);
     max-width: 900px;
     margin: auto;
   }

    .calendar-header {
     display: flex;
     justify-content: space-between;
     align-items: center;
     margin-bottom: 1rem;
   }
   .calendar-grid {
     display: grid;
     grid-template-columns: repeat(7, 1fr); /* 7åˆ—ã®ã‚°ãƒªãƒƒãƒ‰ */
     gap: 5px;
     text-align: center;
   }
   .calendar-day {
     padding: 15px 5px;
     border-radius: 8px;
     position: relative;
   }
   .day-name { font-weight: bold; }
   .has-journal { /* ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãŒæå‡ºã•ã‚Œã¦ã„ã‚‹æ—¥ã®ã‚¹ã‚¿ã‚¤ãƒ« */
     background-color: #fff3e0;
     cursor: pointer;
     font-weight: bold;
   }
   .has-journal::after {
       content: 'ğŸ“'; /* æå‡ºæ¸ˆã¿ãƒãƒ¼ã‚¯ */
       position: absolute;
       bottom: 5px;
       left: 50%;
       transform: translateX(-50%);
   }

   /* --- æ•™å¸«ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
   .teacher-dashboard {
     background-color: white;
     padding: 1.5rem;
     border-radius: 8px;
   }

   .teacher-dashboard button {
     background-color: var(--teacher-accent-color); 
   }

   .teacher-dashboard button:hover {
     background-color: #388E3C;
   }

   .filters {
     display: flex;
     gap: 1rem;
     align-items: center;
     flex-wrap: wrap; /* ç”»é¢ãŒç‹­ã„æ™‚ã«æŠ˜ã‚Šè¿”ã™ */
   }

   .journal-list table {
     width: 100%;
     border-collapse: collapse;
     margin-top: 1rem;
   }

   .journal-list th, .journal-list td {
     border: 1px solid #ddd;
     padding: 8px;
     text-align: left;
   }
   .journal-list th {
     background-color: #f2f2f2;
   }

   .status-badge {
     padding: 3px 8px;
     border-radius: 12px;
     color: white;
     font-size: 0.8em;
   }

   .status-unreturned { background-color: #f44336; } /* æœªè¿”å´ */
   .status-returned { background-color: #4CAF50; } /* è¿”å´æ¸ˆã¿ */

   .teacher-feedback-text {
     color: var(--teacher-pen-color);
     font-family: 'Kiwi Maru', serif;
     white-space: pre-wrap; 
     line-height: 1.8;
     font-size: 1.1em;
   }

   .feedback-section {
     margin-bottom: 1.5rem;
   }

   /* --- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ --- */
   /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
   .modal-overlay {
     display: none; /* æœ€åˆã¯éè¡¨ç¤º */
     position: fixed; 
     z-index: 1000; 
     left: 0; 
     top: 0; 
     width: 100%; 
     height: 100%; 
     overflow: auto; 
     background-color: 
     rgba(0,0,0,0.5); /* åŠé€æ˜ã®èƒŒæ™¯ */
     align-items: center; 
     justify-content: center;
   }
   
   .modal-content {
     background-color: transparent; /* ãƒãƒ¼ãƒˆãƒ‡ã‚¶ã‚¤ãƒ³ã‚’è¦‹ã›ã‚‹ãŸã‚é€æ˜ã« */
     padding: 0; border: none; 
     width: 90%; 
     max-width: 1200px; 
     position: relative; 
     box-shadow: none;
   }

   /* é€šå¸¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
   .simple-modal-content {
     background-color: #fefefe; 
     padding: 20px; 
     border: 1px solid #888; 
     width: 80%; 
     max-width: 500px; 
     border-radius: 10px; 
     position: relative; 
     box-shadow: 0 5px 15px rgba(0,0,0,0.3);
   }

   .modal-close-button {
     position: absolute; 
     top: -10px; 
     right: -10px; 
     background: white; 
     border-radius: 50%; 
     border: 2px solid #333; 
     width: 40px; 
     height: 40px; 
     font-size: 2rem; 
     color: #333; 
     cursor: pointer; 
     z-index: 1100; 
     display: flex; 
     align-items: center; 
     justify-content: center; 
     padding-bottom: 5px;
   }

   .modal-close-button:hover {
     background-color: #f0f0f0;
   }
  
   /* --- ãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
   .highlight-marker {
     background-color: var(--highlight-color);
     cursor: pointer;
     position: relative;
   }

   /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠæ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ */
   #selection-popover {
     position: absolute; 
     background-color: #333; 
     color: white; 
     padding: 5px 10px; 
     border-radius: 5px; 
     z-index: 1200; 
     display: none;
   }

   #selection-popover button {
     background: none; 
     border: none; 
     color: white; 
     padding: 0; 
     font-size: 0.9em;
   }

   /* ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ã‚³ãƒ¡ãƒ³ãƒˆã‚„ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç·¨é›†ã™ã‚‹UI */
   #highlight-editor {
     position: absolute; 
     width: 250px; 
     background: white; 
     border: 1px solid #ccc; 
     border-radius: 8px; 
     box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
     z-index: 1200; 
     padding: 15px; 
     display: none;
   }
   #highlight-editor textarea {
     width: 100%; 
     box-sizing: border-box; 
     margin-bottom: 10px; 
   }
   #highlight-editor .stamps button {
     font-size: 1.2em; 
     padding: 5px; 
     background: #eee; 
     color: #333; 
     border: 1px solid #ccc; 
     margin: 2px;
   }
   #highlight-editor .stamps button.selected {
     background-color: var(--accent-color); 
     color: white;
   }

   /* ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ã‚³ãƒ¡ãƒ³ãƒˆãªã©ã‚’è¡¨ç¤ºã™ã‚‹ãƒ•ã‚­ãƒ€ã‚· */
   #highlight-tooltip {
     position: absolute; 
     background: #333; 
     color: white; 
     padding: 10px 15px; 
     border-radius: 8px; 
     z-index: 1300; 
     display: none; 
     max-width: 250px; 
     pointer-events: none; /* ãƒã‚¦ã‚¹æ“ä½œã‚’ç„¡åŠ¹åŒ– */
     font-size: 0.9em;
   }
   #highlight-tooltip .stamp {
     font-size: 1.5em; 
     margin-right: 8px; 
     vertical-align: middle;
   }

   /* --- æ±ç”¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ --- */
   /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
   .loading-overlay {
     display: flex; 
     position: fixed; 
     top: 0; 
     left: 0; 
     width: 100%; 
     height: 100%; 
     background-color: rgba(255, 255, 255, 0.7); 
     z-index: 2000; 
     justify-content: center; 
     align-items: center; 
     flex-direction: column; 
   }

   .spinner {
     border: 8px solid #f3f3f3; 
     border-top: 8px solid var(--accent-color); 
     border-radius: 50%; 
     width: 60px; 
     height: 60px; 
     animation: spin 1s linear infinite; /* å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
   }

   @keyframes spin {
     0% { transform: rotate(0deg); } 
     100% { transform: rotate(360deg); }
   }
   
   /* â–¼â–¼â–¼ã€æ”¹å–„ç‚¹ã€‘ç”»åƒå…¨ç”»é¢è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« â–¼â–¼â–¼ */
   .fullscreen-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      z-index: 1500;
      justify-content: center;
      align-items: center;
      cursor: pointer;
   }
   .fullscreen-content {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain; /* ç”»åƒã®æ¯”ç‡ã‚’ä¿ã¤ */
   }
   .fullscreen-close-btn {
      position: absolute;
      top: 20px;
      right: 35px;
      color: #fff;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
   }
   /* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */

  </style>
</head>
<body>
 <!-- =================================================================
 HTMLï¼ˆãƒšãƒ¼ã‚¸ã®éª¨æ ¼ï¼‰
 ================================================================== -->

 <!-- JavaScriptã«ã‚ˆã£ã¦ã€ã“ã®ä¸­ã«å…ç«¥ç”¨ã¾ãŸã¯æ•™å¸«ç”¨ã®ç”»é¢ãŒä½œã‚‰ã‚Œã‚‹ -->
 <div id="app"></div>

 <!-- ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­ã«è¡¨ç¤ºã™ã‚‹ã€Œãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã€ç”»é¢ -->
 <div id="loading" class="loading-overlay">
   <div class="spinner"></div><p>ãƒ‡ãƒ¼ã‚¿ã‚’<ruby>èª­<rt>ã‚ˆ</rt></ruby>ã¿<ruby>è¾¼<rt>ã“</rt></ruby>ã‚“ã§ã„ã¾ã™...</p>
 </div>

 <!-- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§è¡¨ç¤ºã•ã‚Œã‚‹ã€Œãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã€ -->
 <div id="modal" class="modal-overlay">
   <div id="modal-content-wrapper" class="modal-content">
     <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¸­èº«ãŒã“ã“ã«å…¥ã‚‹ -->
     <div id="modal-body"></div>
     <!-- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ -->
     <button onclick="closeModal()" class="modal-close-button">&times;</button>
   </div>
 </div>

 <!-- â–¼â–¼â–¼ã€æ”¹å–„ç‚¹ã€‘ç”»åƒå…¨ç”»é¢è¡¨ç¤ºç”¨ã®HTMLè¦ç´ ã‚’è¿½åŠ  â–¼â–¼â–¼ -->
 <div id="fullscreen-image-overlay" class="fullscreen-overlay">
    <span class="fullscreen-close-btn">&times;</span>
    <img class="fullscreen-content" id="fullscreen-image">
 </div>
 <!-- â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² -->

 <!-- æ•™å¸«ãŒãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹ãŸã‚ã®UIè¦ç´  -->
 <div id="selection-popover"><button id="add-highlight-btn">ãƒã‚¤ãƒ©ã‚¤ãƒˆ</button></div>
 <div id="highlight-editor"></div>
 <div id="highlight-tooltip"></div>

 <!-- =================================================================
 JavaScriptï¼ˆãƒšãƒ¼ã‚¸ã®å‹•ãã‚„å‡¦ç†ï¼‰
 ================================================================== -->
 <script>
   /* ------------------------------------------------------------------
    ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãƒ»å®šæ•°
    ------------------------------------------------------------------ */
   // ãƒšãƒ¼ã‚¸å…¨ä½“ã§ä½¿ã†æƒ…å ±ã‚’ä¿å­˜ã—ã¦ãŠããŸã‚ã®å¤‰æ•°

   // ã‚µãƒ¼ãƒãƒ¼ï¼ˆGoogle Apps Scriptï¼‰ã‹ã‚‰æ¸¡ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
   const userData = JSON.parse('<?= JSON.stringify(user) ?>');
   // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ¸¡ã•ã‚ŒãŸã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆå…ç«¥ã¾ãŸã¯ã‚¯ãƒ©ã‚¹å…¨å“¡åˆ†ï¼‰
   const journalsData = JSON.parse('<?= JSON.stringify(journals) ?>');
   // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ¸¡ã•ã‚ŒãŸä»Šæ—¥ã®ãƒ†ãƒ¼ãƒ
   const todayTheme = '<?= todayTheme ?>';

   // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ•™å¸«ã®å ´åˆã®ã¿ã€ã‚¯ãƒ©ã‚¹ã®åç°¿ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
   <? if (user.role === 'æ‹…ä»»') { ?>
     const classRoster = JSON.parse('<?= JSON.stringify(classRoster) ?>');
   <? } else { ?>
     const classRoster = []; // å…ç«¥ã®å ´åˆã¯ç©ºã®é…åˆ—
   <? } ?>

   // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œã«ã‚ˆã£ã¦å¤‰åŒ–ã™ã‚‹å€¤ã‚’ä¿å­˜ã™ã‚‹å¤‰æ•°
   let selectedEmotion = null;    // é¸æŠã•ã‚ŒãŸã€Œæ°—æŒã¡ã€
   let selectedFile = null;       // é¸æŠã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«
   let currentDate = new Date();  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§è¡¨ç¤ºã—ã¦ã„ã‚‹æœˆ
   let currentHighlights = [];    // ç¾åœ¨ç·¨é›†ä¸­ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆæƒ…å ±
   let activeJournalId = null;    // ç¾åœ¨é–‹ã„ã¦ã„ã‚‹ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã®ID
   let selectionRange = null;     // æ•™å¸«ãŒãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ãŸç¯„å›²

   /* ------------------------------------------------------------------
    åˆæœŸåŒ–å‡¦ç†
    ------------------------------------------------------------------ */
   // HTMLã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãŸã¨ãã«æœ€åˆã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†
   document.addEventListener('DOMContentLoaded', function() {
     // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ï¼ˆ'æ‹…ä»»' or 'å…ç«¥'ï¼‰ã«å¿œã˜ã¦è¡¨ç¤ºã™ã‚‹ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
     if (userData.role === 'æ‹…ä»»') {
       renderTeacherView(); // æ•™å¸«ç”¨ã®ç”»é¢ã‚’è¡¨ç¤º
     } else {
       renderStudentView(); // å…ç«¥ç”¨ã®ç”»é¢ã‚’è¡¨ç¤º
     }
     
     // â–¼â–¼â–¼ã€æ”¹å–„ç‚¹ã€‘ç”»åƒå…¨ç”»é¢è¡¨ç¤ºã‚’é–‰ã˜ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š â–¼â–¼â–¼
     const fullscreenOverlay = document.getElementById('fullscreen-image-overlay');
     fullscreenOverlay.addEventListener('click', () => {
       fullscreenOverlay.style.display = 'none';
     });
     // â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²

     // æœ€åˆã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ãŒçµ‚ã‚ã£ãŸã®ã§ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
     hideLoader();
   });

   /* ------------------------------------------------------------------
    ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼æç”»é–¢æ•°
    ------------------------------------------------------------------ */
   // ç”»é¢ã®å¤§éƒ¨åˆ†ã‚’ä½œæˆã—ã¦è¡¨ç¤ºã™ã‚‹ãŸã‚ã®é–¢æ•°ç¾¤

   /**
    * å…ç«¥ç”¨ã®ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚’æç”»ã™ã‚‹
    */
   function renderStudentView() {
     const app = document.getElementById('app');
     app.classList.add('container'); // å…¨ä½“ã‚’å›²ã‚€ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
    
     // ç”»é¢ã®HTMLã‚’ç”Ÿæˆ
     app.innerHTML = `
       <header class="header">
         <h1 class="header-title">ãµã‚Š<ruby>è¿”<rt>ã‹ãˆ</rt></ruby>ã‚Šã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</h1>
         <div class="user-info">
           <span>${escapeHtml(userData.name)} ã•ã‚“</span>
         </div>
       </header>

       <main>
         <!-- ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ï¼ˆã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’æ›¸ã or ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¦‹ã‚‹ï¼‰ -->
         <div class="view-switcher">
           <button id="show-notebook-btn" class="active">ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’<ruby>æ›¸<rt>ã‹</rt></ruby>ã</button>
           <button id="show-calendar-btn">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’<ruby>è¦‹<rt>ã¿</rt></ruby>ã‚‹</button>
         </div>
        
         <!-- ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
         <div id="notebook-view" class="view-content">
           <div class="notebook-container">
             <!-- å·¦ãƒšãƒ¼ã‚¸ -->
             <div class="notebook-page page-left">
               <div class="theme-display">
                 <strong><ruby>ä»Šæ—¥<rt>ãã‚‡ã†</rt></ruby>ã®ãƒ†ãƒ¼ãƒ:</strong> ${escapeHtml(todayTheme)}
               </div>
               <textarea id="journal-content" placeholder="ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
               <div class="submission-area" style="margin-top: auto;">
                 <div class="emotion-stamps">
                   <strong><ruby>ä»Š<rt>ã„ã¾</rt></ruby>ã®<ruby>æ°—æŒ<rt>ãã‚‚</rt></ruby>ã¡:</strong><br>
                   <button class="emotion-btn" data-emotion="ã†ã‚Œã—ã„">ğŸ˜Š ã†ã‚Œã—ã„</button>
                   <button class="emotion-btn" data-emotion="ãã‚„ã—ã„">ğŸ˜  ãã‚„ã—ã„</button>
                   <button class="emotion-btn" data-emotion="ãªã‚‹ã»ã©">ğŸ’¡ ãªã‚‹ã»ã©</button>
                   <button class="emotion-btn" data-emotion="ã‚‚ã‚„ã‚‚ã‚„">ğŸ¤” ã‚‚ã‚„ã‚‚ã‚„</button>
                 </div>
                 <div style="margin-top: 1rem;">
                   <input type="file" id="image-upload" accept="image/*">
                   <div id="preview-area"></div>
                 </div>
               </div>
             </div>
             <!-- å³ãƒšãƒ¼ã‚¸ -->
             <div class="notebook-page page-right">
               <h3><ruby>æ›¸<rt>ã‹</rt></ruby>ãã®ã‚’<ruby>æ‰‹ä¼<rt>ã¦ã¤ã </rt></ruby>ã†ãƒ„ãƒ¼ãƒ«</h3>
               <div class="support-tools">
                 <p><strong>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ:</strong></p>
                 <button id="template-ywt">YWT<ruby>æ³•<rt>ã»ã†</rt></ruby></button>
                 <button id="template-kpt">KPT<ruby>æ³•<rt>ã»ã†</rt></ruby></button>
               </div>
               <div class="support-tools">
                 <p><strong>ãƒ’ãƒ³ãƒˆ:</strong></p>
                 <button id="hint-btn"><ruby>æ›¸<rt>ã‹</rt></ruby>ãã¨ãã®ãƒ’ãƒ³ãƒˆã‚’<ruby>è¦‹<rt>ã¿</rt></ruby>ã‚‹</button>
               </div>
               <div style="margin-top: auto; text-align: right;">
                 <button id="submit-journal" style="font-size: 1.2em; padding: 12px 24px;"><ruby>æå‡º<rt>ã¦ã„ã—ã‚…ã¤</rt></ruby>ã™ã‚‹</button>
               </div>
             </div>
           </div>
         </div>

         <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
         <div id="calendar-view" class="view-content hidden">
            <div class="calendar-container" id="calendar">
              <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒã“ã“ã«æç”»ã•ã‚Œã¾ã™ -->
            </div>
            <div class="support-tools" style="margin-top: 2rem; text-align: center;">
              <button id="past-dialogue-btn">1ãƒ¶æœˆ<ruby>å‰<rt>ã¾ãˆ</rt></ruby>ã®<ruby>è‡ªåˆ†<rt>ã˜ã¶ã‚“</rt></ruby>ã‚’<ruby>è¦‹<rt>ã¿</rt></ruby>ã¦ã¿ã‚ˆã†ï¼</button>
           </div>
         </div>
       </main>
     `;
     // ãƒœã‚¿ãƒ³ãªã©ã®è¦ç´ ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
     addStudentEventListeners();
     // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’åˆæœŸè¡¨ç¤º
     renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
   }

   /**
    * æ•™å¸«ç”¨ã®ãƒ¡ã‚¤ãƒ³ç”»é¢ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰ã‚’æç”»ã™ã‚‹
    */
   function renderTeacherView() {
     const app = document.getElementById('app');
     app.classList.add('container');

     // ç”»é¢ã®HTMLã‚’ç”Ÿæˆ
     app.innerHTML = `
         <header class="header">
           <h1 class="header-title" style="color: var(--teacher-accent-color);">æ•™å“¡ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <div class="user-info">
              <span>${escapeHtml(userData.name)} å…ˆç”Ÿ</span>
            </div>
         </header>
        
         <main class="teacher-dashboard" style="overflow-y: auto;">
           <div class="theme-setter">
             <h3>ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒè¨­å®š</h3>
             <input type="text" id="new-theme-input" placeholder="ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›" size="50" value="${escapeHtml(todayTheme)}">
             <button id="set-theme-btn">ãƒ†ãƒ¼ãƒã‚’è¨­å®š</button>
           </div>
           <hr style="margin: 1.5rem 0;">
           <div class="feedback-tools">
             <h3>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ”¯æ´</h3>
             <!-- â–¼â–¼â–¼ã€æ”¹å–„ç‚¹ã€‘AIæ©Ÿèƒ½ã‚’2ã¤ã®ãƒœã‚¿ãƒ³ã«åˆ†é›¢ â–¼â–¼â–¼ -->
             <button id="ai-simple-comment-btn" style="margin-right: 10px;">AIã‚³ãƒ¡ãƒ³ãƒˆæ¡ˆä½œæˆ (ã‚·ãƒ³ãƒ—ãƒ«)</button>
             <button id="ai-full-feedback-btn">AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ¡ˆä½œæˆ (é«˜åº¦)</button>
             <!-- â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² -->
           </div>
           <hr style="margin: 1.5rem 0;">
           <div class="journal-list">
             <h3>æå‡ºã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ä¸€è¦§</h3>
             <!-- çµã‚Šè¾¼ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
             <div class="filters" style="margin-bottom: 1rem;">
               <label for="student-filter">å…ç«¥:</label>
               <select id="student-filter">
                 <option value="all">ã™ã¹ã¦ã®å…ç«¥</option>
                 ${classRoster.map(s => `<option value="${s.email}">${escapeHtml(s.name)}</option>`).join('')}
               </select>
               <label for="date-filter">æ—¥ä»˜:</label>
               <input type="date" id="date-filter">

                <!-- â–¼â–¼â–¼ã€æ”¹å–„ç‚¹ã€‘çŠ¶æ³ãƒ•ã‚£ãƒ«ã‚¿ã‚’è¿½åŠ  â–¼â–¼â–¼ -->
                <label for="status-filter">çŠ¶æ³:</label>
                <select id="status-filter">
                  <option value="all">ã™ã¹ã¦</option>
                  <option value="æœªè¿”å´">æœªè¿”å´</option>
                  <option value="è¿”å´æ¸ˆã¿">è¿”å´æ¸ˆã¿</option>
                </select>
                <!-- â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² -->

               <button id="filter-reset-btn">ãƒªã‚»ãƒƒãƒˆ</button>
             </div>
             <!-- ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
             <table id="journal-table">
               <thead>
                 <tr>
                   <th>æ—¥ä»˜</th>
                   <th>æ°å</th>
                   <th>ãƒ†ãƒ¼ãƒ</th>
                   <th>çŠ¶æ³</th>
                   <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                 </tr>
               </thead>
               <tbody>
                 ${journalsData.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(j => renderJournalRow(j)).join('')}
               </tbody>
             </table>
           </div>
         </main>
       `;
     // ãƒœã‚¿ãƒ³ãªã©ã®è¦ç´ ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
     addTeacherEventListeners();
   }

   /**
    * æ•™å¸«ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã€Œä¸€è¡Œã€ã‚’ç”Ÿæˆã™ã‚‹
    */
   function renderJournalRow(journal) {
     const statusClass = journal.status === 'è¿”å´æ¸ˆã¿' ? 'status-returned' : 'status-unreturned';
     const date = new Date(journal.timestamp);
     const formattedDate = `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
     
     // ã€Œè¿”å´æ¸ˆã¿ã€ã®å ´åˆã«ã ã‘ã€Œè¿”å´ã‚’å–ã‚Šæ¶ˆã™ã€ãƒœã‚¿ãƒ³ã®HTMLã‚’ç”Ÿæˆ
     const revertButtonHtml = journal.status === 'è¿”å´æ¸ˆã¿' 
       ? `<button class="revert-status-btn" data-journal-id="${journal.journalId}" style="background-color: #757575; margin-left: 5px;">è¿”å´ã‚’å–ã‚Šæ¶ˆã™</button>`
       : '';

     return `
       <tr data-journal-id="${journal.journalId}" data-email="${journal.email}" data-date="${formattedDate}" data-status="${journal.status}">
         <td>${formattedDate}</td>
         <td>${escapeHtml(journal.studentName)}</td>
         <td>${escapeHtml((journal.theme || '').substring(0, 20))}...</td>
         <td><span class="status-badge ${statusClass}">${journal.status}</span></td>
         <td>
            <button class="view-journal-btn" data-journal-id="${journal.journalId}">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã™ã‚‹</button>
            ${revertButtonHtml}
         </td>
       </tr>
     `;
    }

   /**
    * ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»ã™ã‚‹
    */
   function renderCalendar(year, month) {
     const calendarEl = document.getElementById('calendar');
     if (!calendarEl) return; // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¦ç´ ãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„

     // æå‡ºæ¸ˆã¿ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆã«æ ¼ç´ï¼ˆé«˜é€Ÿãªæ¤œç´¢ã®ãŸã‚ï¼‰
     const journalDates = new Set(journalsData.map(j => new Date(j.timestamp).toLocaleDateString("ja-JP")));

     // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®HTMLã‚’ç”Ÿæˆ
     let html = `<div class="calendar-header">
                   <button id="prev-month">&lt;</button>
                   <h3>${year}å¹´ ${month + 1}æœˆ</h3>
                   <button id="next-month">&gt;</button>
                 </div>`;
     html += '<div class="calendar-grid">';
    
     const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
     dayNames.forEach(d => html += `<div class="day-name">${d}</div>`);
    
     const firstDay = new Date(year, month, 1).getDay(); // æœˆã®æœ€åˆã®æ—¥ã®æ›œæ—¥
     const lastDate = new Date(year, month + 1, 0).getDate(); // æœˆã®æœ€å¾Œã®æ—¥
    
     // 1æ—¥ã‚ˆã‚Šå‰ã®ç©ºç™½ãƒã‚¹ã‚’åŸ‹ã‚ã‚‹
     for (let i = 0; i < firstDay; i++) {
       html += '<div></div>';
     }

     // 1æ—¥ã‹ã‚‰æœ€å¾Œã®æ—¥ã¾ã§ã‚’ç”Ÿæˆ
     for (let i = 1; i <= lastDate; i++) {
       const d = new Date(year, month, i);
       const dateString = d.toLocaleDateString("ja-JP");
       const hasJournal = journalDates.has(dateString); // ã“ã®æ—¥ã«ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãŒã‚ã‚‹ã‹
       html += `<div class="calendar-day ${hasJournal ? 'has-journal' : ''}" data-date="${dateString}">${i}</div>`;
     }
    
     html += '</div>';
     calendarEl.innerHTML = html;
    
     // ã€Œå‰æœˆã€ã€Œæ¬¡æœˆã€ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
     document.getElementById('prev-month').onclick = () => {
       currentDate.setMonth(currentDate.getMonth() - 1);
       renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
     };
     document.getElementById('next-month').onclick = () => {
       currentDate.setMonth(currentDate.getMonth() + 1);
       renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
     };
    
     // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãŒã‚ã‚‹æ—¥ä»˜ãƒã‚¹ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
     document.querySelectorAll('.has-journal').forEach(day => {
       day.onclick = (e) => {
         const clickedDate = e.target.dataset.date;
         // åŒã˜æ—¥ä»˜ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ã™ã¹ã¦å–å¾—
         const journalsOnDate = journalsData.filter(j => new Date(j.timestamp).toLocaleDateString("ja-JP") === clickedDate);
         if(journalsOnDate.length > 0) {
           showStudentJournalModal(journalsOnDate, 0, false); // æœ€åˆã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤º
         }
       };
     });
   }

   /* ------------------------------------------------------------------
    ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šé–¢æ•°
    ------------------------------------------------------------------ */
   // ãƒœã‚¿ãƒ³ãªã©ã®è¦ç´ ã«ã€ã‚¯ãƒªãƒƒã‚¯ãªã©ã®æ“ä½œï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰ãŒã‚ã£ãŸéš›ã®å‡¦ç†ã‚’å‰²ã‚Šå½“ã¦ã‚‹é–¢æ•°ç¾¤

   /**
    * å…ç«¥ç”»é¢ã®è¦ç´ ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ã™ã‚‹
    */
   function addStudentEventListeners() {
     document.getElementById('submit-journal').addEventListener('click', handleSubmit);
     document.querySelectorAll('.emotion-btn').forEach(btn => btn.addEventListener('click', handleEmotionSelect));
     document.getElementById('image-upload').addEventListener('change', handleFileSelect);
     document.getElementById('template-ywt').addEventListener('click', () => insertTemplate('ywt'));
     document.getElementById('template-kpt').addEventListener('click', () => insertTemplate('kpt'));
     document.getElementById('hint-btn').addEventListener('click', showHint);
     document.getElementById('past-dialogue-btn').addEventListener('click', showPastJournal);
    
     // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®å‡¦ç†
     const showNotebookBtn = document.getElementById('show-notebook-btn');
     const showCalendarBtn = document.getElementById('show-calendar-btn');
     const notebookView = document.getElementById('notebook-view');
     const calendarView = document.getElementById('calendar-view');


     showNotebookBtn.addEventListener('click', () => {
       showNotebookBtn.classList.add('active');
       showCalendarBtn.classList.remove('active');
       notebookView.classList.remove('hidden');
       calendarView.classList.add('hidden');
     });
     showCalendarBtn.addEventListener('click', () => {
       showCalendarBtn.classList.add('active');
       showNotebookBtn.classList.remove('active');
       calendarView.classList.remove('hidden');
       notebookView.classList.add('hidden');
     });
   }
  
   /**
    * æ•™å¸«ç”»é¢ã®è¦ç´ ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ã™ã‚‹
    */
   function addTeacherEventListeners() {
     document.getElementById('set-theme-btn').addEventListener('click', handleSetTheme);
     document.getElementById('ai-simple-comment-btn').addEventListener('click', handleAiSimpleCommentGeneration);
     document.getElementById('ai-full-feedback-btn').addEventListener('click', handleAiFullFeedbackGeneration);

     // ã‚¤ãƒ™ãƒ³ãƒˆå§”ä»»ã‚’ä½¿ã„ã€ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã§ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’åŠ¹ç‡çš„ã«å‡¦ç†
     document.getElementById('journal-table').addEventListener('click', (e) => {
        // ã€Œãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã™ã‚‹ã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸå ´åˆ
        if (e.target.classList.contains('view-journal-btn')) {
            const journalId = e.target.dataset.journalId;
            const journal = journalsData.find(j => j.journalId === journalId);
            if (journal) showTeacherJournalModal(journal);
        }
        // ã€Œè¿”å´ã‚’å–ã‚Šæ¶ˆã™ã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸå ´åˆ
        if (e.target.classList.contains('revert-status-btn')) {
            const journalId = e.target.dataset.journalId;
            handleRevertStatus(journalId);
        }
     });

     // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆ
     document.getElementById('student-filter').addEventListener('change', filterJournals);
     document.getElementById('date-filter').addEventListener('change', filterJournals);
     document.getElementById('status-filter').addEventListener('change', filterJournals);
     document.getElementById('filter-reset-btn').addEventListener('click', () => {
       document.getElementById('student-filter').value = 'all';
       document.getElementById('date-filter').value = '';
       document.getElementById('status-filter').value = 'all';
       filterJournals();
     });
   }

   /* ------------------------------------------------------------------
    ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©é–¢æ•°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã¸ã®å¿œç­”ï¼‰
    ------------------------------------------------------------------ */
   // ã‚¯ãƒªãƒƒã‚¯ãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ãŸã¨ãã«ã€å…·ä½“çš„ã«ä½•ã‚’ã™ã‚‹ã‹ã‚’å®šç¾©ã—ãŸé–¢æ•°ç¾¤

   /**
    * [å…ç«¥] ã€Œæå‡ºã™ã‚‹ã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†
    */
   function handleSubmit() {
     const content = document.getElementById('journal-content').value;
     if (!content.trim()) {
       showNotificationModal('æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
       return;
     }
     showLoader(); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’è¡¨ç¤º
    
     const journalData = {
       email: userData.email,
       theme: todayTheme,
       content: content,
       emotion: selectedEmotion
     };
    
     // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
     if (selectedFile) {
       const reader = new FileReader();
       reader.onload = function(e) {
         const fileData = {
           fileName: selectedFile.name,
           mimeType: selectedFile.type,
           data: e.target.result.split(',')[1] // Base64ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†
         };
         // ã‚µãƒ¼ãƒãƒ¼ã«ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
         google.script.run
           .withSuccessHandler(response => {
             if (response.success) {
               journalData.imageFileId = response.fileId;
               saveJournalToServer(journalData);
             } else {
               hideLoader();
               showNotificationModal(response.message);
             }
           })
           .withFailureHandler(err => {
             hideLoader();
             showNotificationModal('ã‚¨ãƒ©ãƒ¼: ' + err.message);
           })
           .uploadImage(fileData);
       };
       reader.readAsDataURL(selectedFile);
     } else {
       // ç”»åƒãŒãªã„å ´åˆã¯ãã®ã¾ã¾ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
       saveJournalToServer(journalData);
     }
   }
  
   /**
    * [å…ç«¥] ã€Œæ°—æŒã¡ã€ãƒœã‚¿ãƒ³ãŒé¸æŠã•ã‚ŒãŸã¨ãã®å‡¦ç†
    */
   function handleEmotionSelect(e) {
     document.querySelectorAll('.emotion-btn').forEach(btn => btn.classList.remove('selected'));
     e.target.classList.add('selected');
     selectedEmotion = e.target.dataset.emotion;
   }

   /**
    * [å…ç«¥] ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸã¨ãã®å‡¦ç†
    */
   function handleFileSelect(e) {
     selectedFile = e.target.files[0];
     if (selectedFile) {
       const reader = new FileReader();
       reader.onload = function(event) {
         const previewArea = document.getElementById('preview-area');
         previewArea.innerHTML = `<img src="${event.target.result}" style="max-width: 100%; max-height: 100px; margin-top: 10px;">`;
       };
       reader.readAsDataURL(selectedFile);
     }
   }

   /**
    * [å…ç«¥] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒœã‚¿ãƒ³ï¼ˆYWT/KPTï¼‰ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†
    */
   function insertTemplate(type) {
     const contentArea = document.getElementById('journal-content');
     let templateText = '';
     if (type === 'ywt') {
       templateText = 'ã€Y: ã‚„ã£ãŸã“ã¨ã€‘\n\nã€W: ã‚ã‹ã£ãŸã“ã¨ã€‘\n\nã€T: ã¤ãã«ã‚„ã‚‹ã“ã¨ã€‘\n';
     } else if (type === 'kpt') {
       templateText = 'ã€K: Keep ã‚ˆã‹ã£ãŸã“ã¨ãƒ»ã¤ã¥ã‘ã‚‹ã“ã¨ã€‘\n\nã€P: Problem ã“ã¾ã£ãŸã“ã¨ãƒ»ã‚„ã‚ã‚‹ã“ã¨ã€‘\n\nã€T: Try ã¤ãã«ãŸã‚ã™ã“ã¨ã€‘\n';
     }
     contentArea.value += templateText;
     contentArea.focus(); // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’åˆã‚ã›ã‚‹
   }

   /**
    * [å…ç«¥] ãƒ’ãƒ³ãƒˆãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†
    */
   function showHint() {
     const hintText = `
       <h3><ruby>æ›¸<rt>ã‹</rt></ruby>ãã¨ãã®ãƒ’ãƒ³ãƒˆ</h3>
       <ul>
         <li><ruby>ä»Šæ—¥<rt>ãã‚‡ã†</rt></ruby>ã€<ruby>ä¸€ç•ª<rt>ã„ã¡ã°ã‚“</rt></ruby>ã“ã“ã‚ã«<ruby>æ®‹<rt>ã®ã“</rt></ruby>ã£ãŸã“ã¨ã¯ãªã‚“ã§ã™ã‹ï¼Ÿ</li>
         <li>ãªã«ã‹ã€<ruby>æ–°<rt>ã‚ãŸã‚‰</rt></ruby>ã—ãã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</li>
         <li>ã ã‚Œã‹ã«ã€Œã‚ã‚ŠãŒã¨ã†ã€ã¨<ruby>è¨€<rt>ã„</rt></ruby>ã„ãŸã„ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</li>
         <li>ã€Œãªãœã ã‚ã†ï¼Ÿã€ã¨<ruby>æ€<rt>ãŠã‚‚</rt></ruby>ã£ãŸã“ã¨ã¯ã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿ</li>
       </ul>
     `;
     showNotificationModal(hintText);
   }

   /**
    * [å…ç«¥] ã€Œ1ãƒ¶æœˆå‰ã®è‡ªåˆ†ã‚’è¦‹ã¦ã¿ã‚ˆã†ã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†
    */
   function showPastJournal() {
     const oneMonthAgo = new Date();
     oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
    
     const pastJournals = journalsData.filter(j => new Date(j.timestamp) < oneMonthAgo);
     if (pastJournals.length === 0) {
       showNotificationModal('1ãƒ¶æœˆä»¥ä¸Šå‰ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
       return;
     }
    
     // éå»ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸ã‚“ã§è¡¨ç¤º
     const randomJournal = pastJournals[Math.floor(Math.random() * pastJournals.length)];
     showStudentJournalModal([randomJournal], 0, true);
   }

   /**
    * [æ•™å¸«] ã€Œãƒ†ãƒ¼ãƒã‚’è¨­å®šã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†
    */
   function handleSetTheme() {
     const newTheme = document.getElementById('new-theme-input').value;
     if (!newTheme.trim()) {
       showNotificationModal('ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
       return;
     }
     showLoader();
     google.script.run
       .withSuccessHandler(response => {
         hideLoader();
         if(response.success) {
           showNotificationModal(response.message, reloadPage);
         } else {
           showNotificationModal(response.message);
         }
       })
       .withFailureHandler(err => {
         hideLoader();
         showNotificationModal('ã‚¨ãƒ©ãƒ¼: ' + err.message);
       })
       .setTodayTheme(newTheme);
   }

   /**
    * [æ•™å¸«] ã€ŒAIã‚³ãƒ¡ãƒ³ãƒˆæ¡ˆä½œæˆ (ã‚·ãƒ³ãƒ—ãƒ«)ã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†
    */
   function handleAiSimpleCommentGeneration() {
     const message = 'æœªè¿”å´ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã™ã¹ã¦ã«AIã§ã‚³ãƒ¡ãƒ³ãƒˆæ¡ˆã‚’ä½œæˆã—ã¾ã™ã€‚\nï¼ˆæ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰';
     showConfirmationModal(message, () => {
       showLoader();
       google.script.run
         .withSuccessHandler(response => {
           hideLoader();
           showNotificationModal(response.message, reloadPage);
         })
         .withFailureHandler(err => {
           hideLoader();
           showNotificationModal('ã‚¨ãƒ©ãƒ¼: ' + err.message);
         })
         .generateAiSimpleCommentsForAll();
     });
   }

   /**
    * [æ•™å¸«] ã€ŒAIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ¡ˆä½œæˆ (é«˜åº¦)ã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†
    */
   function handleAiFullFeedbackGeneration() {
     const message = 'æœªè¿”å´ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã™ã¹ã¦ã«AIã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ¡ˆï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã€ãƒã‚¤ãƒ©ã‚¤ãƒˆã€ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰ã‚’ä½œæˆã—ã¾ã™ã€‚\nï¼ˆæ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰';
     showConfirmationModal(message, () => {
       showLoader();
       google.script.run
         .withSuccessHandler(response => {
           hideLoader();
           showNotificationModal(response.message, reloadPage);
         })
         .withFailureHandler(err => {
           hideLoader();
           showNotificationModal('ã‚¨ãƒ©ãƒ¼: ' + err.message);
         })
         .generateAiFullFeedbackForAll();
     });
   }

   /**
    * [æ•™å¸«] ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§ã€Œã‚³ãƒ¡ãƒ³ãƒˆã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ä¿å­˜ã—ã¦è¿”å´ã™ã‚‹ã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†
    */
   function handleSaveFeedback(journalId) {
     const comment = document.getElementById(`teacher-comment-${journalId}`).value;
     const feedbackData = {
       journalId: journalId,
       comment: comment,
       highlights: JSON.stringify(currentHighlights), // ãƒã‚¤ãƒ©ã‚¤ãƒˆæƒ…å ±ã‚’JSONæ–‡å­—åˆ—ã«å¤‰æ›
     };
    
     showLoader();
     google.script.run
       .withSuccessHandler(response => {
         hideLoader();
         if(response.success) {
           // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
           const journalIndex = journalsData.findIndex(j => j.journalId === journalId);
           if (journalIndex > -1) {
             journalsData[journalIndex].teacherComment = feedbackData.comment;
             journalsData[journalIndex].highlights = feedbackData.highlights;
             journalsData[journalIndex].status = 'è¿”å´æ¸ˆã¿';
           }
           
           // UIã‚’æ›´æ–°
           const row = document.querySelector(`tr[data-journal-id="${journalId}"]`);
           if (row) {
             const statusBadge = row.querySelector('.status-badge');
             statusBadge.textContent = 'è¿”å´æ¸ˆã¿';
             statusBadge.classList.remove('status-unreturned');
             statusBadge.classList.add('status-returned');
             row.dataset.status = 'è¿”å´æ¸ˆã¿';

             // â–¼â–¼â–¼ã€é‡è¦ã€‘ã€Œè¿”å´ã‚’å–ã‚Šæ¶ˆã™ã€ãƒœã‚¿ãƒ³ã‚’å³åº§ã«è¿½åŠ  â–¼â–¼â–¼
             const actionCell = row.querySelector('td:last-child');
             if (actionCell && !actionCell.querySelector('.revert-status-btn')) {
                const revertButton = document.createElement('button');
                revertButton.className = 'revert-status-btn';
                revertButton.dataset.journalId = journalId;
                revertButton.style.backgroundColor = '#757575';
                revertButton.style.marginLeft = '5px';
                revertButton.textContent = 'è¿”å´ã‚’å–ã‚Šæ¶ˆã™';
                actionCell.appendChild(revertButton);
             }
           }
           closeModal();
           showNotificationModal(response.message);
         } else {
           showNotificationModal(response.message);
         }
       })
       .withFailureHandler(err => {
         hideLoader();
         showNotificationModal('ã‚¨ãƒ©ãƒ¼: ' + err.message);
       })
       .saveFeedback(feedbackData);
   }

   /**
    * [æ•™å¸«] ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ä¸€è¦§ã‚’çµã‚Šè¾¼ã‚€å‡¦ç†
    */
   function filterJournals() {
     const studentEmail = document.getElementById('student-filter').value;
     const filterDate = document.getElementById('date-filter').value;
     // â–¼â–¼â–¼ã€æ”¹å–„ç‚¹ã€‘çŠ¶æ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®å€¤ã‚’å–å¾— â–¼â–¼â–¼
     const statusFilter = document.getElementById('status-filter').value;
     
     const rows = document.querySelectorAll('#journal-table tbody tr');
    
     rows.forEach(row => {
       const rowEmail = row.dataset.email;
       const rowDate = row.dataset.date;
       // â–¼â–¼â–¼ã€æ”¹å–„ç‚¹ã€‘è¡Œã®çŠ¶æ³ã‚’å–å¾— â–¼â–¼â–¼
       const rowStatus = row.dataset.status;

       const studentMatch = (studentEmail === 'all' || rowEmail === studentEmail);
       const dateMatch = (!filterDate || rowDate === filterDate.replace(/-/g, '/'));
       // â–¼â–¼â–¼ã€æ”¹å–„ç‚¹ã€‘çŠ¶æ³ãŒä¸€è‡´ã™ã‚‹ã‹åˆ¤å®š â–¼â–¼â–¼
       const statusMatch = (statusFilter === 'all' || rowStatus === statusFilter);
      
       // â–¼â–¼â–¼ã€æ”¹å–„ç‚¹ã€‘ã™ã¹ã¦ã®æ¡ä»¶ã«ä¸€è‡´ã™ã‚Œã°è¡¨ç¤º â–¼â–¼â–¼
       if (studentMatch && dateMatch && statusMatch) {
         row.style.display = '';
       } else {
         row.style.display = 'none';
       }
     });
   }

   /**
    * [æ•™å¸«] ã€Œè¿”å´ã‚’å–ã‚Šæ¶ˆã™ã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç† (æ¥½è¦³çš„UIæ›´æ–°)
    */
   function handleRevertStatus(journalId) {
      // 1. å…ˆã«UIã‚’å³åº§ã«æ›´æ–°ã™ã‚‹
      const row = document.querySelector(`tr[data-journal-id="${journalId}"]`);
      if (!row) return;

      const statusBadge = row.querySelector('.status-badge');
      statusBadge.textContent = 'æœªè¿”å´';
      statusBadge.classList.remove('status-returned');
      statusBadge.classList.add('status-unreturned');
      row.dataset.status = 'æœªè¿”å´';
      
      const revertButton = row.querySelector('.revert-status-btn');
      if(revertButton) revertButton.remove();

      // 2. ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
      const journalIndex = journalsData.findIndex(j => j.journalId === journalId);
      if (journalIndex > -1) {
          journalsData[journalIndex].status = 'æœªè¿”å´';
      }

      // 3. è£ã§ã‚µãƒ¼ãƒãƒ¼ã«é€šä¿¡ã™ã‚‹ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºãªã—ï¼‰
      google.script.run
        .withFailureHandler(err => {
            // 4. ä¸‡ãŒä¸€å¤±æ•—ã—ãŸå ´åˆã€UIã¨ãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã«æˆ»ã™
            showNotificationModal('ã‚¨ãƒ©ãƒ¼: è¿”å´ã®å–ã‚Šæ¶ˆã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç”»é¢ã‚’å…ƒã«æˆ»ã—ã¾ã™ã€‚');
            
            statusBadge.textContent = 'è¿”å´æ¸ˆã¿';
            statusBadge.classList.add('status-returned');
            statusBadge.classList.remove('status-unreturned');
            row.dataset.status = 'è¿”å´æ¸ˆã¿';

            // ãƒœã‚¿ãƒ³ã‚’å†ç”Ÿæˆã—ã¦è¿½åŠ 
            const actionCell = row.querySelector('td:last-child');
            if (actionCell && !actionCell.querySelector('.revert-status-btn')) {
                const newRevertButton = document.createElement('button');
                newRevertButton.className = 'revert-status-btn';
                newRevertButton.dataset.journalId = journalId;
                newRevertButton.style.backgroundColor = '#757575';
                newRevertButton.style.marginLeft = '5px';
                newRevertButton.textContent = 'è¿”å´ã‚’å–ã‚Šæ¶ˆã™';
                actionCell.appendChild(newRevertButton);
            }
            
            if (journalIndex > -1) {
                journalsData[journalIndex].status = 'è¿”å´æ¸ˆã¿';
            }
        })
        .revertJournalStatus(journalId);
   }

   /* ------------------------------------------------------------------
    ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ (Google Apps Script)
    ------------------------------------------------------------------ */
   // ã‚µãƒ¼ãƒãƒ¼å´ã®å‡¦ç†ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®é–¢æ•°ç¾¤

   /**
    * [å…ç«¥] çµ„ã¿ç«‹ã¦ãŸã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ã£ã¦ä¿å­˜ã™ã‚‹
    */
   function saveJournalToServer(journalData) {
     google.script.run
       .withSuccessHandler(response => {
         hideLoader();
         if (response.success) {
           showNotificationModal(response.message, reloadPage); // æˆåŠŸã—ãŸã‚‰ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
         } else {
           showNotificationModal(response.message);
         }
       })
       .withFailureHandler(err => {
         hideLoader();
         showNotificationModal('ã‚¨ãƒ©ãƒ¼: ' + err.message);
       })
       .saveJournal(journalData);
   }

   /**
    * [å…ç«¥] éå»ã®è‡ªåˆ†ã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ã£ã¦ä¿å­˜ã™ã‚‹
    */
   function savePastComment(journalId) {
      const comment = document.getElementById('past-comment-input').value;
     if (!comment.trim()) {
       showNotificationModal('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
       return;
     }
    
     showLoader();
     google.script.run
       .withSuccessHandler(res => {
         hideLoader();
         showNotificationModal(res.message, () => {
           if (res.success) {
             // ç”»é¢ä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†è¡¨ç¤º
             const updatedJournal = journalsData.find(j => j.journalId === journalId);
             if(updatedJournal) {
               updatedJournal.pastComment = comment;
               showStudentJournalModal([updatedJournal], 0, true);
             }
           }
         });
       })
       .addPastComment(journalId, comment);
   }

   /* ------------------------------------------------------------------
    UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¶å¾¡é–¢æ•° (ãƒ¢ãƒ¼ãƒ€ãƒ«ãªã©)
    ------------------------------------------------------------------ */
   // ç”»é¢éƒ¨å“ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºã‚’åˆ¶å¾¡ã™ã‚‹é–¢æ•°ç¾¤

   /**
    * ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹
    */
   function showLoader() { document.getElementById('loading').style.display = 'flex'; }

   /**
    * ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    */
   function hideLoader() { document.getElementById('loading').style.display = 'none'; }

   /**
    * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤ºã™ã‚‹
    * @param {string} content - ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤ºã™ã‚‹HTML
    * @param {boolean} isNotebook - ãƒãƒ¼ãƒˆå½¢å¼ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã©ã†ã‹
    */
   function showModal(content, isNotebook = false) {
     const modalBody = document.getElementById('modal-body');
     const modalContentWrapper = document.getElementById('modal-content-wrapper');
    
     // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ç¨®é¡ã«å¿œã˜ã¦ã‚¹ã‚¿ã‚¤ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
     if (isNotebook) {
       modalContentWrapper.classList.remove('simple-modal-content');
     } else {
       modalContentWrapper.classList.add('simple-modal-content');
     }


     modalBody.innerHTML = content;
     document.getElementById('modal').style.display = 'flex';
   }

   /**
    * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹
    */
   function closeModal() {
     // ãƒã‚¤ãƒ©ã‚¤ãƒˆé–¢é€£ã®UIã‚‚éè¡¨ç¤ºã«ã™ã‚‹
     document.getElementById('selection-popover').style.display = 'none';
     document.getElementById('highlight-editor').style.display = 'none';
     document.getElementById('modal').style.display = 'none';
     document.getElementById('modal-body').innerHTML = '';

     // å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
     currentHighlights = [];
     activeJournalId = null;
   }
  
   // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«ã‚‚é–‰ã˜ã‚‹ã‚ˆã†ã«ã™ã‚‹
   window.onclick = function(event) {
     const modal = document.getElementById('modal');
     if (event.target == modal) closeModal();
   }

   /**
    * [å…ç«¥] éå»ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤ºã™ã‚‹
    * @param {array} journalsOnDate - è¡¨ç¤ºå¯¾è±¡ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆåŒã˜æ—¥ã®ã‚‚ã®ãŒè¤‡æ•°ã‚ã‚‹å ´åˆã‚‚ï¼‰
    * @param {number} indexToShow - journalsOnDateã®ä½•ç•ªç›®ã‚’è¡¨ç¤ºã™ã‚‹ã‹
    * @param {boolean} isPastDialogue - ã€Œéå»ã¨ã®å¯¾è©±ã€ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹
    */
   function showStudentJournalModal(journalsOnDate, indexToShow, isPastDialogue = false) {
     const journal = isPastDialogue ? journalsOnDate[0] : journalsOnDate[indexToShow];
     if (!journal) return;

     const imageHtml = journal.imageUrl 
       ? `<img src="${journal.imageUrl}" class="journal-image" style="max-width: 200px; margin-top: 10px; border-radius: 5px;" alt="æ·»ä»˜ç”»åƒ">`
       : '';

     // ã€Œéå»ã¨ã®å¯¾è©±ã€ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®è¿½åŠ HTML
     let dialogueHtml = '';
     if (isPastDialogue) {
       dialogueHtml = `
         <div class="feedback-section">
           <h4><ruby>ã„ã¾<rt>ã„ã¾</rt></ruby>ã®<ruby>è‡ªåˆ†<rt>ã˜ã¶ã‚“</rt></ruby>ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚’<ruby>é€<rt>ãŠã</rt></ruby>ã‚ã†</h4>
           <textarea id="past-comment-input" rows="4" style="width: 95%;" placeholder="1ãƒ¶æœˆå‰ã®è‡ªåˆ†ã¸...">${escapeHtml(journal.pastComment || '')}</textarea>
           <button onclick="savePastComment('${journal.journalId}')" style="margin-top: 10px;"><ruby>ä¿å­˜<rt>ã»ãã‚“</rt></ruby>ã™ã‚‹</button>
         </div>`;
     }
    
     // åŒã˜æ—¥ã«è¤‡æ•°ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãŒã‚ã‚‹å ´åˆã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
     let paginationHtml = '';
     if (!isPastDialogue && journalsOnDate.length > 1) {
         paginationHtml += '<div class="pagination-controls" style="text-align:center; margin-top:1rem;">';
         journalsOnDate.forEach((_, i) => {
             paginationHtml += `<button class="page-btn ${i === indexToShow ? 'active' : ''}" data-index="${i}">${i + 1}</button>`;
         });
         paginationHtml += '</div>';
     }

     // ãƒã‚¤ãƒ©ã‚¤ãƒˆæƒ…å ±ã‚’è§£æã—ã€ãƒã‚¤ãƒ©ã‚¤ãƒˆä»˜ãã®æœ¬æ–‡HTMLã‚’ç”Ÿæˆ
     const highlights = (typeof journal.highlights === 'string' && journal.highlights.startsWith('[')) ? JSON.parse(journal.highlights) : [];
     const contentWithHighlights = renderContentWithHighlights(journal.content, highlights, false);

     // æœªè¿”å´ã®å ´åˆã«AIä¸‹æ›¸ããŒè¡¨ç¤ºã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
     const teacherCommentHtml = (journal.status === 'è¿”å´æ¸ˆã¿' ? escapeHtml(journal.teacherComment) : 'ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“');

     // ãƒ¢ãƒ¼ãƒ€ãƒ«å…¨ä½“ã®HTMLã‚’ç”Ÿæˆ
     const modalHtml = `
       <div class="notebook-container" style="margin: 0; max-height: 85vh; min-height: 0;">
         <div class="notebook-page page-left" id="student-journal-page-left">
           <div class="theme-display">
               <strong><ruby>æ—¥ä»˜<rt>ã²ã¥ã‘</rt></ruby>:</strong> ${new Date(journal.timestamp).toLocaleDateString()}<br>
               <strong>ãƒ†ãƒ¼ãƒ:</strong> ${escapeHtml(journal.theme || '')}
           </div>
           <div class="journal-content-display">${contentWithHighlights}</div>
           <div class="submission-area" style="margin-top: auto;">
              <div class="emotion-stamps"><strong><ruby>æ°—æŒ<rt>ãã‚‚</rt></ruby>ã¡:</strong> ${escapeHtml(journal.emotion || 'ï¼ˆãˆã‚‰ã‚“ã§ã„ã¾ã›ã‚“ï¼‰')}</div>
              <div id="image-container-${journal.journalId}" style="margin-top: 1rem;">${imageHtml}</div>
           </div>
         </div>
         <div class="notebook-page page-right">
           ${paginationHtml}
           <div class="feedback-section">
             <h4><ruby>å…ˆç”Ÿ<rt>ã›ã‚“ã›ã„</rt></ruby>ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ</h4>
             <p class="teacher-feedback-text">${teacherCommentHtml.replace(/\n/g, '<br>')}</p>
           </div>
           <div class="feedback-section">
             <h4><ruby>æœªæ¥<rt>ã¿ã‚‰ã„</rt></ruby>ã®<ruby>è‡ªåˆ†<rt>ã˜ã¶ã‚“</rt></ruby>ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ</h4>
             <p>${escapeHtml(journal.pastComment || 'ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“').replace(/\n/g, '<br>')}</p>
           </div>
           ${dialogueHtml}
         </div>
       </div>`;
     showModal(modalHtml, true);
    
     // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šï¼ˆè¦ç´ ãŒç”Ÿæˆã•ã‚Œã¦ã‹ã‚‰ã§ãªã„ã¨è¨­å®šã§ããªã„ãŸã‚ï¼‰
     setTimeout(() => {
       addStudentHighlightEventListeners(highlights);
       document.querySelectorAll('.page-btn').forEach(btn => {
           btn.addEventListener('click', (e) => {
               const newIndex = parseInt(e.target.dataset.index, 10);
               showStudentJournalModal(journalsOnDate, newIndex, false);
           });
       });
       // â–¼â–¼â–¼ã€æ”¹å–„ç‚¹ã€‘ç”»åƒã‚¯ãƒªãƒƒã‚¯ã§å…¨ç”»é¢è¡¨ç¤ºã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ  â–¼â–¼â–¼
       document.querySelectorAll('.journal-image').forEach(img => {
            img.addEventListener('click', (e) => showFullscreenImage(e.target.src));
       });
     }, 100);
   }

   /**
    * [æ•™å¸«] å…ç«¥ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”¨ã«ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã™ã‚‹
    */
   function showTeacherJournalModal(journal) {
      activeJournalId = journal.journalId;
     currentHighlights = (typeof journal.highlights === 'string' && journal.highlights.startsWith('[')) ? JSON.parse(journal.highlights) : [];
     
     const imageHtml = journal.imageUrl
       ? `<img src="${journal.imageUrl}" class="journal-image" style="max-width: 200px; margin-top: 10px; border-radius: 5px;" alt="æ·»ä»˜ç”»åƒ">`
       : '';
    
     // æ•™å¸«ãŒç·¨é›†å¯èƒ½ãªãƒã‚¤ãƒ©ã‚¤ãƒˆä»˜ãæœ¬æ–‡HTMLã‚’ç”Ÿæˆ
     const contentWithHighlights = renderContentWithHighlights(journal.content, currentHighlights, true);

     const modalHtml = `
       <div class="notebook-container" style="margin: 0; max-height: 85vh; min-height: 0;">
          <div class="notebook-page page-left">
           <div class="theme-display">
               <strong>æ—¥ä»˜:</strong> ${journal.date}<br>
               <strong>æ°å:</strong> ${escapeHtml(journal.studentName)}<br>
               <strong>ãƒ†ãƒ¼ãƒ:</strong> ${escapeHtml(journal.theme || '')}
           </div>
           <div class="journal-content-display" id="teacher-journal-content">${contentWithHighlights}</div>
           <div class="submission-area" style="margin-top: auto;">
              <div class="emotion-stamps"><strong>æ°—æŒã¡:</strong> ${escapeHtml(journal.emotion || 'ï¼ˆãˆã‚‰ã‚“ã§ã„ã¾ã›ã‚“ï¼‰')}</div>
              <div id="image-container-${journal.journalId}" style="margin-top: 1rem;">${imageHtml}</div>
           </div>
         </div>
         <div class="notebook-page page-right">
           <h4>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å…¥åŠ›</h4>
           <textarea id="teacher-comment-${journal.journalId}" rows="12" style="width: 95%; font-family: var(--font-family); font-size: 1em; flex-grow: 1;">${escapeHtml(journal.teacherComment || '')}</textarea>
           <div style="margin-top: auto; text-align:right;">
             <button onclick="handleSaveFeedback('${journal.journalId}')" style="background-color: var(--teacher-accent-color);">ã‚³ãƒ¡ãƒ³ãƒˆã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ä¿å­˜ã—ã¦è¿”å´ã™ã‚‹</button>
           </div>
         </div>
       </div>`;
     showModal(modalHtml, true);
    
     // ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚„ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¯ãƒªãƒƒã‚¯ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
     const contentArea = document.getElementById('teacher-journal-content');
     contentArea.addEventListener('mouseup', handleTextSelection);
     contentArea.addEventListener('click', handleHighlightClick);
     // â–¼â–¼â–¼ã€æ”¹å–„ç‚¹ã€‘ç”»åƒã‚¯ãƒªãƒƒã‚¯ã§å…¨ç”»é¢è¡¨ç¤ºã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ  â–¼â–¼â–¼
     setTimeout(() => {
        document.querySelectorAll('.journal-image').forEach(img => {
            img.addEventListener('click', (e) => showFullscreenImage(e.target.src));
        });
     }, 100);
   }

   /**
    * OKãƒœã‚¿ãƒ³ã ã‘ã®ã‚·ãƒ³ãƒ—ãƒ«ãªé€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
    */
   function showNotificationModal(message, onOk = null) {
     const content = `
       <div class="simple-modal-content">
         <div style="font-size: 1.1em;">${message}</div>
         <div style="text-align: center; margin-top: 20px;">
           <button id="modal-ok-button">OK</button>
         </div>
       </div>`;
     showModal(content, false);
     document.getElementById('modal-ok-button').onclick = () => {
       closeModal();
       if (onOk) onOk(); // onOkãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°å®Ÿè¡Œ
     };
   }

   /**
    * ã€Œã¯ã„ã€ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãŒé¸ã¹ã‚‹ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
    */
   function showConfirmationModal(message, onConfirm) {
     const content = `
       <div class="simple-modal-content">
         <p style="text-align: center; margin: 20px 0; font-size: 1.1em;">${message.replace(/\n/g, '<br>')}</p>
         <div style="text-align: center; margin-top: 20px; display: flex; justify-content: center; gap: 20px;">
           <button id="modal-confirm-button">ã¯ã„</button>
           <button id="modal-cancel-button" style="background-color: #757575;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
         </div>
       </div>`;
     showModal(content, false);
     document.getElementById('modal-confirm-button').onclick = () => {
       closeModal();
       if (onConfirm) onConfirm();
     };
     document.getElementById('modal-cancel-button').onclick = closeModal;
   }
   
   /**
    * â–¼â–¼â–¼ã€æ”¹å–„ç‚¹ã€‘ç”»åƒã‚’å…¨ç”»é¢è¡¨ç¤ºã™ã‚‹é–¢æ•° â–¼â–¼â–¼
    * @param {string} imageUrl - è¡¨ç¤ºã™ã‚‹ç”»åƒã®URL
    */
   function showFullscreenImage(imageUrl) {
        const overlay = document.getElementById('fullscreen-image-overlay');
        const image = document.getElementById('fullscreen-image');
        image.src = imageUrl;
        overlay.style.display = 'flex';
   }


   /* ------------------------------------------------------------------
    ãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½é–¢é€£
    ------------------------------------------------------------------ */
   // æ•™å¸«ãŒå…ç«¥ã®æ–‡ç« ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å¼•ã„ãŸã‚Šã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã¤ã‘ãŸã‚Šã™ã‚‹æ©Ÿèƒ½ã®é–¢æ•°ç¾¤

   /**
    * [æ•™å¸«] ãƒ†ã‚­ã‚¹ãƒˆãŒé¸æŠã•ã‚ŒãŸã¨ãã«ã€Œãƒã‚¤ãƒ©ã‚¤ãƒˆã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹
    */
   function handleTextSelection(e) {
     const popover = document.getElementById('selection-popover');
     // ãƒã‚¤ãƒ©ã‚¤ãƒˆç·¨é›†ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã¨ãã¯ä½•ã‚‚ã—ãªã„
     if(document.getElementById('highlight-editor').style.display === 'block') return;

     const selection = window.getSelection();
     // ãƒ†ã‚­ã‚¹ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ï¼ˆç¯„å›²ãŒæŠ˜ã‚ŠãŸãŸã¾ã‚Œã¦ã„ãªã„ï¼‰å ´åˆ
     if (!selection.isCollapsed && selection.rangeCount > 0) {
       selectionRange = selection.getRangeAt(0);
       const rect = selectionRange.getBoundingClientRect();
       
       // ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ã®è¿‘ãã«ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ã‚’è¡¨ç¤º
       popover.style.left = `${e.clientX}px`;
       popover.style.top = `${e.clientY - 40}px`;
       popover.style.display = 'block';

       document.getElementById('add-highlight-btn').onclick = createHighlight;
     } else {
       popover.style.display = 'none';
     }
   }

   /**
    * [æ•™å¸«] ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ä½œæˆã™ã‚‹
    */
   function createHighlight() {
     const contentArea = document.getElementById('teacher-journal-content');
     const popover = document.getElementById('selection-popover');
     popover.style.display = 'none';

     if (!selectionRange) return;

     // æ–°ã—ã„ãƒã‚¤ãƒ©ã‚¤ãƒˆã®æƒ…å ±ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ä½œæˆ
     const newHighlight = {
       id: 'hl-' + Date.now(), // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’ç”Ÿæˆ
       text: selectionRange.toString(),
       comment: '',
       stamp: '',
       startOffset: getCharOffset(contentArea, selectionRange.startContainer, selectionRange.startOffset),
       endOffset: getCharOffset(contentArea, selectionRange.endContainer, selectionRange.endOffset)
     };
    
     currentHighlights.push(newHighlight);
     redrawTeacherContentWithHighlights(); // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’åæ˜ ã—ã¦å†æç”»
     showHighlightEditor(newHighlight.id, document.querySelector(`[data-highlight-id="${newHighlight.id}"]`));
   }

   /**
    * [æ•™å¸«] æ—¢å­˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®å‡¦ç†
    */
   function handleHighlightClick(e) {
      if (e.target.classList.contains('highlight-marker')) {
        const highlightId = e.target.dataset.highlightId;
        showHighlightEditor(highlightId, e.target);
      }
   }

   /**
    * [æ•™å¸«] ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ã‚³ãƒ¡ãƒ³ãƒˆã‚„ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç·¨é›†ã™ã‚‹ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤ºã™ã‚‹
    */
   function showHighlightEditor(highlightId, targetElement) {
     const editor = document.getElementById('highlight-editor');
     const highlight = currentHighlights.find(h => h.id === highlightId);
     if (!highlight) return;

     // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒã‚¤ãƒ©ã‚¤ãƒˆã®è¿‘ãã«è¡¨ç¤º
     const rect = targetElement.getBoundingClientRect();
     editor.style.top = `${window.scrollY + rect.bottom + 5}px`;
     editor.style.left = `${window.scrollX + rect.left}px`;
    
     const stamps = ['ğŸ˜„', 'ğŸ˜‚', 'ğŸ¤”', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ’¯', 'â¤', 'ğŸ‘', 'ğŸ‰', 'âœ¨', 'ğŸ’ª', 'ğŸŒ±'];
     editor.innerHTML = `
       <textarea id="highlight-comment-input" rows="4" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›...">${highlight.comment}</textarea>
       <div class="stamps">
         ${stamps.map(s => `<button class="stamp-btn ${highlight.stamp === s ? 'selected' : ''}" data-stamp="${s}">${s}</button>`).join('')}
       </div>
       <div style="margin-top: 10px; display: flex; justify-content: space-between;">
         <button id="save-highlight-btn" style="background-color:var(--teacher-accent-color)">ä¿å­˜</button>
         <button id="delete-highlight-btn" style="background-color:#757575">å‰Šé™¤</button>
       </div>
     `;
     editor.style.display = 'block';
    
     // å„ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
     document.getElementById('save-highlight-btn').onclick = () => saveHighlight(highlightId);
     document.getElementById('delete-highlight-btn').onclick = () => deleteHighlight(highlightId);
     editor.querySelectorAll('.stamp-btn').forEach(btn => {
       btn.onclick = () => {
         editor.querySelectorAll('.stamp-btn').forEach(b => b.classList.remove('selected'));
         btn.classList.add('selected');
       }
     });
   }

   /**
    * [æ•™å¸«] ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ç·¨é›†å†…å®¹ã‚’ä¿å­˜ã™ã‚‹
    */
   function saveHighlight(highlightId) {
     const highlight = currentHighlights.find(h => h.id === highlightId);
     if (highlight) {
       highlight.comment = document.getElementById('highlight-comment-input').value;
       const selectedStamp = document.querySelector('#highlight-editor .stamp-btn.selected');
       highlight.stamp = selectedStamp ? selectedStamp.dataset.stamp : '';
     }
     document.getElementById('highlight-editor').style.display = 'none';
     redrawTeacherContentWithHighlights();
   }

   /**
    * [æ•™å¸«] ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤ã™ã‚‹
    */
   function deleteHighlight(highlightId) {
     currentHighlights = currentHighlights.filter(h => h.id !== highlightId);
     document.getElementById('highlight-editor').style.display = 'none';
     redrawTeacherContentWithHighlights();
   }
  
   /**
    * [æ•™å¸«] ãƒã‚¤ãƒ©ã‚¤ãƒˆæƒ…å ±ã‚’å…ƒã«æ•™å¸«ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æœ¬æ–‡ã‚’å†æç”»ã™ã‚‹
    */
   function redrawTeacherContentWithHighlights() {
     const journal = journalsData.find(j => j.journalId === activeJournalId);
     const contentArea = document.getElementById('teacher-journal-content');
     if (journal && contentArea) {
       contentArea.innerHTML = renderContentWithHighlights(journal.content, currentHighlights, true);
     }
   }

   /**
    * æœ¬æ–‡ã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆæƒ…å ±ã‹ã‚‰ã€ãƒã‚¤ãƒ©ã‚¤ãƒˆä»˜ãã®HTMLã‚’ç”Ÿæˆã™ã‚‹
    */
   function renderContentWithHighlights(content, highlights, isTeacher) {
     let resultHtml = '';
     let lastIndex = 0;
    
     // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’é–‹å§‹ä½ç½®ã§ã‚½ãƒ¼ãƒˆã™ã‚‹ï¼ˆå¿…é ˆï¼‰
     const sortedHighlights = [...highlights].sort((a, b) => a.startOffset - b.startOffset);
    
     sortedHighlights.forEach(h => {
       // å‰å›ãƒã‚¤ãƒ©ã‚¤ãƒˆå¾Œã‹ã‚‰ã€ä»Šå›ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆé–‹å§‹ä½ç½®ã¾ã§ã®å¹³æ–‡ã‚’è¿½åŠ 
       resultHtml += escapeHtml(content.substring(lastIndex, h.startOffset));
       // ãƒã‚¤ãƒ©ã‚¤ãƒˆéƒ¨åˆ†ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’<mark>ã‚¿ã‚°ã§å›²ã‚€
       const highlightedText = escapeHtml(content.substring(h.startOffset, h.endOffset));
       const tag = `<mark class="highlight-marker" data-highlight-id="${h.id}">${highlightedText}</mark>`;
       resultHtml += tag;
       lastIndex = h.endOffset;
     });
     // æœ€å¾Œã®ãƒã‚¤ãƒ©ã‚¤ãƒˆä»¥é™ã®å¹³æ–‡ã‚’è¿½åŠ 
     resultHtml += escapeHtml(content.substring(lastIndex));
     
     return resultHtml.replace(/\n/g, '<br>');
   }

   /**
    * [å…ç«¥] é–²è¦§ç”¨ãƒã‚¤ãƒ©ã‚¤ãƒˆã«ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šã™ã‚‹
    */
   function addStudentHighlightEventListeners(highlights) {
     const markers = document.querySelectorAll('#student-journal-page-left .highlight-marker');
     markers.forEach(marker => {
       const highlightId = marker.dataset.highlightId;
       const highlightData = highlights.find(h => h.id === highlightId);
       if (highlightData && (highlightData.comment || highlightData.stamp)) {
           // ãƒã‚¦ã‚¹ã‚’ä¹—ã›ãŸã‚Šã€é›¢ã—ãŸã‚Šã€ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆ
           marker.addEventListener('mouseenter', (e) => showHighlightTooltip(e, highlightData));
           marker.addEventListener('mouseleave', hideHighlightTooltip);
           marker.addEventListener('click', (e) => showHighlightTooltip(e, highlightData));
       }
     });
     // ãƒã‚¤ãƒ©ã‚¤ãƒˆä»¥å¤–ã®å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’æ¶ˆã™
     document.getElementById('student-journal-page-left').addEventListener('click', (e) => {
          if (!e.target.classList.contains('highlight-marker')) {
              hideHighlightTooltip();
          }
     }, true);
   }

   /**
    * [å…ç«¥] ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ã‚³ãƒ¡ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆãƒ•ã‚­ãƒ€ã‚·ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹
    */
   function showHighlightTooltip(event, highlight) {
       const tooltip = document.getElementById('highlight-tooltip');
       if (!highlight || (!highlight.comment && !highlight.stamp)) return;


       tooltip.innerHTML = `<span class="stamp">${highlight.stamp || ''}</span> ${escapeHtml(highlight.comment)}`;
       const rect = event.target.getBoundingClientRect();
       tooltip.style.left = `${rect.left + window.scrollX}px`;
       tooltip.style.top = `${rect.bottom + window.scrollY + 5}px`;
       tooltip.style.display = 'block';
   }

   /**
    * [å…ç«¥] ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ã‚³ãƒ¡ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    */
   function hideHighlightTooltip() {
       document.getElementById('highlight-tooltip').style.display = 'none';
   }

   /* ------------------------------------------------------------------
    ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ï¼ˆè£œåŠ©çš„ãªå‡¦ç†ï¼‰
    ------------------------------------------------------------------ */
   // æ§˜ã€…ãªå ´æ‰€ã§ä½¿ã‚ã‚Œã‚‹ä¾¿åˆ©ãªé–¢æ•°ç¾¤

   /**
    * ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹
    */
   function reloadPage() {
       showLoader();
     google.script.run
       .withSuccessHandler(url => {
         window.top.location.href = url; // ãƒšãƒ¼ã‚¸ã®URLã‚’å–å¾—ã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
       })
       .withFailureHandler(err => {
         hideLoader();
         showNotificationModal('ãƒšãƒ¼ã‚¸ã®å†èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
       })
       .getScriptUrl();
   }

   /**
    * ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ä½ç½®ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã€ãƒ†ã‚­ã‚¹ãƒˆã®å…ˆé ­ã‹ã‚‰ã®æ–‡å­—æ•°ã‚’è¨ˆç®—ã™ã‚‹
    * ï¼ˆè¤‡é›‘ãªå‡¦ç†ãªã®ã§è©³ç´°ãªèª¬æ˜ã¯å‰²æ„›ï¼‰
    */
   function getCharOffset(container, node, offset) {
     let charCount = 0;
     let found = false;
     function traverse(n) {
         if (found) return;
         if (n === node) {
             charCount += offset;
             found = true;
             return;
         }
         if (n.nodeType === Node.TEXT_NODE) {
             charCount += n.textContent.length;
         } else if (n.nodeType === Node.ELEMENT_NODE && n.tagName !== 'RT') { // <rt>ã‚¿ã‚°ã®ä¸­ã¯æ•°ãˆãªã„
             for (let child of n.childNodes) {
                 traverse(child);
                 if (found) return;
             }
         }
     }
     traverse(container);
     return charCount;
   }

   /**
    * HTMLã‚¿ã‚°ã¨ã—ã¦è§£é‡ˆã•ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹æ–‡å­—ã‚’å®‰å…¨ãªæ–‡å­—åˆ—ã«å¤‰æ›ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰ã™ã‚‹
    */
   function escapeHtml(str) {
      if (typeof str !== 'string') return '';
     return str.replace(/[&<>"']/g, match => ({
       '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
     }[match]));
   }
 </script>
</body>
</html>

