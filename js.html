
<script>
  /* ============================================================
   * ãµã‚Šè¿”ã‚Šã‚¸ãƒ£ãƒ¼ãƒŠãƒ« â€” ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ JavaScript (js.html)
   * ============================================================
   * SPAï¼ˆSingle Page Applicationï¼‰æ§‹æˆã§ã€ç”»é¢é·ç§»ã¯DOMã®
   * è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆã§è¡Œã„ã€ãƒšãƒ¼ã‚¸å…¨ä½“ã®ãƒªãƒ­ãƒ¼ãƒ‰ã‚’é˜²æ­¢ã™ã‚‹ã€‚
   *
   * ä¸»ãªæ©Ÿèƒ½:
   *   - google.script.run ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆãƒªãƒˆãƒ©ã‚¤ãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
   *   - SweetAlert2 ã«ã‚ˆã‚‹é€šçŸ¥
   *   - å…ç«¥ç”»é¢ï¼ˆã‚¸ãƒ£ãƒ¼ãƒŠãƒ«å…¥åŠ›ãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»éå»ã¨ã®å¯¾è©±ï¼‰
   *   - æ•™å“¡ç”»é¢ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ»AIé€£æºï¼‰
   *   - ãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½
   * ============================================================ */

  // =============================================================
  // â–  1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãƒ»åˆæœŸãƒ‡ãƒ¼ã‚¿
  // =============================================================

  // â€» userData, todayTheme, journalsData, classRoster ã¯
  //    index.html ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚°ã§å®šç¾©æ¸ˆã¿ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼‰

  /** çŠ¶æ…‹ç®¡ç†ç”¨ã®å¤‰æ•° */
  let selectedEmotion = null;   // é¸æŠä¸­ã®ã€Œæ°—æŒã¡ã€
  let selectedFile = null;   // é¸æŠã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«
  let currentDate = new Date(); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºæœˆ
  let currentHighlights = [];     // ç·¨é›†ä¸­ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆæƒ…å ±
  let activeJournalId = null;   // ç¾åœ¨é–‹ã„ã¦ã„ã‚‹ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ID
  let selectionRange = null;   // ãƒ†ã‚­ã‚¹ãƒˆé¸æŠç¯„å›²


  // =============================================================
  // â–  2. google.script.run ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆãƒªãƒˆãƒ©ã‚¤ãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
  // =============================================================

  /**
   * google.script.run ã‚’ Promise ã§ã‚«ãƒ—ã‚»ãƒ«åŒ–ã™ã‚‹ãƒ©ãƒƒãƒ‘ãƒ¼
   * - æœ€å¤§3å›ã®è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤
   * - ã‚¨ãƒ©ãƒ¼æ™‚ã¯ SweetAlert2 ã§é€šçŸ¥
   * - é€šä¿¡ä¸­ã¯ã‚¹ãƒ”ãƒŠãƒ¼ã‚’è¡¨ç¤º
   *
   * @param {string} functionName - GASå´ã®é–¢æ•°å
   * @param {...*} args - é–¢æ•°ã«æ¸¡ã™å¼•æ•°
   * @returns {Promise<*>} GASé–¢æ•°ã®æˆ»ã‚Šå€¤
   */
  function callGas(functionName, ...args) {
    const MAX_RETRIES = 3;
    const RETRY_DELAY = 1500; // ms

    return new Promise((resolve, reject) => {
      let attempt = 0;

      function tryCall() {
        attempt++;
        const runner = google.script.run
          .withSuccessHandler(result => resolve(result))
          .withFailureHandler(error => {
            if (attempt < MAX_RETRIES) {
              console.warn(`[callGas] ${functionName} ãƒªãƒˆãƒ©ã‚¤ ${attempt}/${MAX_RETRIES}: ${error.message}`);
              setTimeout(tryCall, RETRY_DELAY);
            } else {
              reject(error);
            }
          });
        runner[functionName](...args);
      }

      tryCall();
    });
  }

  /**
   * callGas ã‚’ã‚¹ãƒ”ãƒŠãƒ¼ä»˜ãã§å‘¼ã³å‡ºã™ä¾¿åˆ©é–¢æ•°
   * @param {string} functionName
   * @param {...*} args
   * @returns {Promise<*>}
   */
  async function callGasWithSpinner(functionName, ...args) {
    showSpinner();
    try {
      const result = await callGas(functionName, ...args);
      return result;
    } catch (error) {
      Swal.fire({
        icon: 'error',
        title: 'ã‚¨ãƒ©ãƒ¼',
        text: error.message || 'é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚',
        confirmButtonText: 'OK'
      });
      throw error;
    } finally {
      hideSpinner();
    }
  }


  // =============================================================
  // â–  3. ã‚¹ãƒ”ãƒŠãƒ¼åˆ¶å¾¡
  // =============================================================

  /** ã‚¹ãƒ”ãƒŠãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ */
  function showSpinner() {
    const el = document.getElementById('loading-overlay');
    if (el) el.classList.remove('d-none');
  }

  /** ã‚¹ãƒ”ãƒŠãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
  function hideSpinner() {
    const el = document.getElementById('loading-overlay');
    if (el) el.classList.add('d-none');
  }


  // =============================================================
  // â–  4. åˆæœŸåŒ–å‡¦ç†
  // =============================================================

  document.addEventListener('DOMContentLoaded', () => {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã«å¿œã˜ã¦ç”»é¢ã‚’è¡¨ç¤º
    if (userData.role === 'æ‹…ä»»') {
      renderTeacherView();
    } else {
      renderStudentView();
    }

    // ç”»åƒå…¨ç”»é¢è¡¨ç¤ºã®é–‰ã˜ã‚‹å‡¦ç†
    const fsOverlay = document.getElementById('fullscreen-image-overlay');
    if (fsOverlay) {
      fsOverlay.addEventListener('click', () => {
        fsOverlay.classList.remove('show');
      });
    }

    // ã‚¹ãƒ”ãƒŠãƒ¼ã‚’éè¡¨ç¤º
    hideSpinner();
  });


  // =============================================================
  // â–  5. SPA ãƒšãƒ¼ã‚¸åˆ‡æ›¿
  // =============================================================

  /**
   * æŒ‡å®šã—ãŸãƒšãƒ¼ã‚¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã—ã€ä»–ã‚’éè¡¨ç¤ºã«ã™ã‚‹
   * @param {string} pageId - è¡¨ç¤ºã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã® ID
   */
  function showPage(pageId) {
    document.querySelectorAll('.page-section').forEach(sec => {
      sec.classList.remove('active');
    });
    const target = document.getElementById(pageId);
    if (target) target.classList.add('active');
  }


  // =============================================================
  // â–  6. å…ç«¥ç”»é¢ã®æç”»ã¨ã‚¤ãƒ™ãƒ³ãƒˆ
  // =============================================================

  /** å…ç«¥ç”»é¢ã‚’æç”»ã™ã‚‹ */
  function renderStudentView() {
    const app = document.getElementById('app-content');

    app.innerHTML = `
    <div class="student-layout">
      <!-- å·¦ã‚µã‚¤ãƒ‰ï¼šãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
      <aside class="side-calendar">
        <div class="calendar-container mini-calendar" id="calendar"></div>
        <button class="past-dialogue-mini" id="past-dialogue-btn">
          <i class="bi bi-clock-history"></i> <ruby>éå»<rt>ã‹ã“</rt></ruby>ã®<ruby>è‡ªåˆ†<rt>ã˜ã¶ã‚“</rt></ruby>
        </button>
      </aside>
      <!-- ãƒ¡ã‚¤ãƒ³ï¼šãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ -->
      <div class="notebook-container">
        <!-- å·¦ãƒšãƒ¼ã‚¸ï¼šè¨˜å…¥ã‚¨ãƒªã‚¢ -->
        <div class="notebook-page page-left">
          <div class="theme-display">
            <strong><i class="bi bi-chat-quote-fill"></i> <ruby>ä»Šæ—¥<rt>ãã‚‡ã†</rt></ruby>ã®ãƒ†ãƒ¼ãƒ:</strong>
            ${escapeHtml(todayTheme)}
          </div>
          <textarea id="journal-content" placeholder="ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
          <div class="char-counter" id="char-counter">0 <ruby>æ–‡å­—<rt>ã‚‚ã˜</rt></ruby></div>
        </div>
        <!-- å³ãƒšãƒ¼ã‚¸ï¼šãƒ„ãƒ¼ãƒ« + æ„Ÿæƒ… + æå‡º -->
        <div class="notebook-page page-right">
          <div class="support-tools">
            <p><i class="bi bi-list-check"></i> ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ:</p>
            <div class="support-tools-grid">
              <button class="template-btn" id="template-ywt">ğŸ“‹ YWT<ruby>æ³•<rt>ã»ã†</rt></ruby></button>
              <button class="template-btn" id="template-kpt">ğŸ“‹ KPT<ruby>æ³•<rt>ã»ã†</rt></ruby></button>
              <button class="template-btn" id="template-5w1h">ğŸ“‹ 5W1H</button>
              <button class="template-btn" id="template-3notice">ğŸ“‹ 3ã¤ã®ãã¥ã</button>
            </div>
          </div>
          <div class="support-tools">
            <p><i class="bi bi-pencil"></i> <ruby>æ›¸<rt>ã‹</rt></ruby>ã<ruby>å‡º<rt>ã </rt></ruby>ã—:</p>
            <button class="starter-btn" id="starter-btn">ğŸ¯ ãã‚‡ã†ã®<ruby>ä¸€æ–‡<rt>ã„ã¡ã¶ã‚“</rt></ruby></button>
          </div>
          <div class="support-tools">
            <p><i class="bi bi-lightbulb"></i> ãƒ’ãƒ³ãƒˆ:</p>
            <button class="hint-btn" id="hint-btn">ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’<ruby>é–‹<rt>ã²ã‚‰</rt></ruby>ã</button>
          </div>
          <hr class="tools-divider">
          <div class="emotion-stamps">
            <span class="label"><ruby>æ°—æŒ<rt>ãã‚‚</rt></ruby>ã¡:</span>
            <button class="emotion-btn" data-emotion="ã†ã‚Œã—ã„">ğŸ˜Š</button>
            <button class="emotion-btn" data-emotion="ãã‚„ã—ã„">ğŸ˜ </button>
            <button class="emotion-btn" data-emotion="ãªã‚‹ã»ã©">ğŸ’¡</button>
            <button class="emotion-btn" data-emotion="ã‚‚ã‚„ã‚‚ã‚„">ğŸ¤”</button>
          </div>
          <div class="file-upload-wrapper">
            <label class="file-upload-label">
              <i class="bi bi-image"></i> <ruby>ç”»åƒ<rt>ãŒãã†</rt></ruby>ã‚’ãˆã‚‰ã¶
              <input type="file" id="image-upload" accept="image/*">
            </label>
            <div id="preview-area" class="image-preview"></div>
          </div>
          <div style="margin-top: auto; text-align: right;">
            <button class="btn-primary-kid" id="submit-journal" style="font-size: 1.1rem; padding: 12px 28px;">
              <i class="bi bi-send-fill"></i> <ruby>æå‡º<rt>ã¦ã„ã—ã‚…ã¤</rt></ruby>ã™ã‚‹
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- ãƒ’ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« -->
    <div class="hint-side-panel" id="hint-side-panel">
      <div class="hint-panel-header">
        <span class="hint-panel-title">ğŸ’¡ <ruby>æ›¸<rt>ã‹</rt></ruby>ãã¨ãã®ãƒ’ãƒ³ãƒˆ</span>
        <button class="hint-panel-close" id="hint-panel-close"><i class="bi bi-x-lg"></i></button>
      </div>
      <div class="hint-panel-body">
        <div class="hint-card" style="background:linear-gradient(135deg,#fff8e1,#fff3e0);">
          <div class="hint-card-title">ğŸ˜Š <ruby>æ°—æŒ<rt>ãã‚‚</rt></ruby>ã¡</div>
          <ul>
            <li><ruby>ä»Šæ—¥<rt>ãã‚‡ã†</rt></ruby>ã€ã„ã¡ã°ã‚“ã†ã‚Œã—ã‹ã£ãŸã“ã¨ã¯ï¼Ÿ</li>
            <li>ãã‚„ã—ã‹ã£ãŸã“ã¨ãƒ»ã‹ãªã—ã‹ã£ãŸã“ã¨ã¯ï¼Ÿ</li>
            <li>ãƒ‰ã‚­ãƒ‰ã‚­ãƒ»ãƒ¯ã‚¯ãƒ¯ã‚¯ã—ãŸ<ruby>ç¬é–“<rt>ã—ã‚…ã‚“ã‹ã‚“</rt></ruby>ã¯ï¼Ÿ</li>
          </ul>
        </div>
        <div class="hint-card" style="background:linear-gradient(135deg,#e8f5e9,#c8e6c9);">
          <div class="hint-card-title">ğŸ“š <ruby>å­¦<rt>ã¾ãª</rt></ruby>ã³</div>
          <ul>
            <li><ruby>æ–°<rt>ã‚ãŸã‚‰</rt></ruby>ã—ãã‚ã‹ã£ãŸã“ã¨ãƒ»ã§ããŸã“ã¨ã¯ï¼Ÿ</li>
            <li>ã€Œãªãœã ã‚ã†ï¼Ÿã€ã¨<ruby>æ€<rt>ãŠã‚‚</rt></ruby>ã£ãŸã“ã¨ã¯ï¼Ÿ</li>
            <li>ã‚‚ã£ã¨<ruby>èª¿<rt>ã—ã‚‰</rt></ruby>ã¹ãŸã„ãƒ»<ruby>çŸ¥<rt>ã—</rt></ruby>ã‚ŠãŸã„ã“ã¨ã¯ï¼Ÿ</li>
          </ul>
        </div>
        <div class="hint-card" style="background:linear-gradient(135deg,#e3f2fd,#bbdefb);">
          <div class="hint-card-title">ğŸ¤ <ruby>äºº<rt>ã²ã¨</rt></ruby>ã¨ã®ã¤ãªãŒã‚Š</div>
          <ul>
            <li><ruby>å‹<rt>ã¨ã‚‚</rt></ruby>ã ã¡ã«ã€Œã‚ã‚ŠãŒã¨ã†ã€ã¨<ruby>è¨€<rt>ã„</rt></ruby>ã„ãŸã„ã“ã¨ã¯ï¼Ÿ</li>
            <li>ã ã‚Œã‹ã®ã€Œã™ã”ã„ãªã€ã¨<ruby>æ€<rt>ãŠã‚‚</rt></ruby>ã£ãŸã¨ã“ã‚ã¯ï¼Ÿ</li>
            <li>ã¿ã‚“ãªã§<ruby>å”åŠ›<rt>ãã‚‡ã†ã‚Šã‚‡ã</rt></ruby>ã—ã¦ã§ããŸã“ã¨ã¯ï¼Ÿ</li>
          </ul>
        </div>
        <div class="hint-card" style="background:linear-gradient(135deg,#fce4ec,#f8bbd0);">
          <div class="hint-card-title">ğŸ”„ ãµã‚Šã‹ãˆã‚Š</div>
          <ul>
            <li><ruby>æ˜æ—¥<rt>ã‚ã—ãŸ</rt></ruby>ãŒã‚“ã°ã‚ŠãŸã„ã“ã¨ã¯ï¼Ÿ</li>
            <li>ã‚‚ã†<ruby>ä¸€åº¦<rt>ã„ã¡ã©</rt></ruby>ã‚„ã‚‹ãªã‚‰ã€ã©ã†ã™ã‚‹ï¼Ÿ</li>
            <li><ruby>ä»Šæ—¥<rt>ãã‚‡ã†</rt></ruby>ã®<ruby>è‡ªåˆ†<rt>ã˜ã¶ã‚“</rt></ruby>ã«ã²ã¨ã“ã¨<ruby>è¨€<rt>ã„</rt></ruby>ã†ãªã‚‰ï¼Ÿ</li>
          </ul>
        </div>
      </div>
    </div>
  `;

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    addStudentEventListeners();
    renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
  }

  /** å…ç«¥ç”»é¢ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹ */
  function addStudentEventListeners() {
    // æå‡ºãƒœã‚¿ãƒ³
    document.getElementById('submit-journal').addEventListener('click', handleSubmit);

    // æ°—æŒã¡ãƒœã‚¿ãƒ³
    document.querySelectorAll('.emotion-btn').forEach(btn =>
      btn.addEventListener('click', handleEmotionSelect)
    );

    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    document.getElementById('image-upload').addEventListener('change', handleFileSelect);

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
    document.getElementById('template-ywt').addEventListener('click', () => insertTemplate('ywt'));
    document.getElementById('template-kpt').addEventListener('click', () => insertTemplate('kpt'));
    document.getElementById('template-5w1h').addEventListener('click', () => insertTemplate('5w1h'));
    document.getElementById('template-3notice').addEventListener('click', () => insertTemplate('3notice'));

    // ãã‚‡ã†ã®ä¸€æ–‡ï¼ˆãƒ©ãƒ³ãƒ€ãƒ æ›¸ãå‡ºã—ï¼‰
    document.getElementById('starter-btn').addEventListener('click', insertStarter);

    // ãƒ’ãƒ³ãƒˆ
    document.getElementById('hint-btn').addEventListener('click', showHint);
    document.getElementById('hint-panel-close').addEventListener('click', showHint);

    // æ–‡å­—ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
    const journalTextarea = document.getElementById('journal-content');
    journalTextarea.addEventListener('input', updateCharCounter);
    updateCharCounter(); // åˆæœŸè¡¨ç¤º

    // éå»ã®è‡ªåˆ†
    document.getElementById('past-dialogue-btn').addEventListener('click', showPastJournal);
  }


  // =============================================================
  // â–  7. æ•™å¸«ç”»é¢ã®æç”»ã¨ã‚¤ãƒ™ãƒ³ãƒˆ
  // =============================================================

  /** æ•™å¸«ç”»é¢ã‚’æç”»ã™ã‚‹ */
  function renderTeacherView() {
    const app = document.getElementById('app-content');

    // ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã‚’ç”Ÿæˆ
    const sortedJournals = [...journalsData].sort((a, b) =>
      new Date(b.timestamp) - new Date(a.timestamp)
    );
    const tableRows = sortedJournals.map(j => renderJournalRow(j)).join('');

    // å…ç«¥ã‚»ãƒ¬ã‚¯ã‚¿ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    const rosterOptions = classRoster.map(s =>
      `<option value="${s.email}">${escapeHtml(s.name)}</option>`
    ).join('');

    // ç®¡ç†ã‚¿ãƒ–ï¼ˆç®¡ç†è€…ã®ã¿è¡¨ç¤ºï¼‰
    const adminTab = isAdmin ? `
      <button class="view-tab-btn" id="tab-admin">
        <i class="bi bi-gear-fill"></i> è¨­å®š
      </button>` : '';

    app.innerHTML = `
    <!-- ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿ã‚¿ãƒ– -->
    <div class="view-tabs">
      <button class="view-tab-btn active" id="tab-dashboard">
        <i class="bi bi-speedometer2"></i> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
      </button>
      ${adminTab}
    </div>

    <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="page-section active" id="page-dashboard">
      <!-- ãƒ†ãƒ¼ãƒè¨­å®š -->
      <div class="giga-card teacher-section">
        <div class="giga-card-title"><i class="bi bi-chat-square-text-fill"></i> ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒè¨­å®š</div>
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <input type="text" class="theme-setter-input" id="new-theme-input"
                 placeholder="ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›" value="${escapeHtml(todayTheme)}">
          <button class="btn-teacher" id="set-theme-btn">
            <i class="bi bi-check-lg"></i> ãƒ†ãƒ¼ãƒã‚’è¨­å®š
          </button>
        </div>
        <details class="weekly-theme-details" id="weekly-theme-section">
          <summary class="weekly-theme-summary">
            <i class="bi bi-calendar-week"></i> é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
          </summary>
          <div class="weekly-theme-grid" id="weekly-theme-grid">
            <div class="weekly-theme-row"><label>æœˆ</label><input type="text" id="theme-mon" placeholder="æœˆæ›œã®ãƒ†ãƒ¼ãƒ"></div>
            <div class="weekly-theme-row"><label>ç«</label><input type="text" id="theme-tue" placeholder="ç«æ›œã®ãƒ†ãƒ¼ãƒ"></div>
            <div class="weekly-theme-row"><label>æ°´</label><input type="text" id="theme-wed" placeholder="æ°´æ›œã®ãƒ†ãƒ¼ãƒ"></div>
            <div class="weekly-theme-row"><label>æœ¨</label><input type="text" id="theme-thu" placeholder="æœ¨æ›œã®ãƒ†ãƒ¼ãƒ"></div>
            <div class="weekly-theme-row"><label>é‡‘</label><input type="text" id="theme-fri" placeholder="é‡‘æ›œã®ãƒ†ãƒ¼ãƒ"></div>
          </div>
          <button class="btn-teacher btn-sm" id="save-weekly-themes-btn">
            <i class="bi bi-save"></i> é€±é–“ãƒ†ãƒ¼ãƒã‚’ä¿å­˜
          </button>
        </details>
      </div>

      <!-- ä»Šæ—¥ã®ã‚µãƒãƒªãƒ¼ -->
      <div class="giga-card teacher-section summary-card" id="today-summary">
        <div class="giga-card-title"><i class="bi bi-bar-chart-fill"></i> ä»Šæ—¥ã®ã‚µãƒãƒªãƒ¼</div>
        <div class="summary-content" id="summary-content">
          <div style="text-align:center;padding:8px;"><i class="bi bi-arrow-repeat spin-icon"></i> èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>


      <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ”¯æ´ -->
      <div class="giga-card teacher-section">
        <div class="giga-card-title"><i class="bi bi-robot"></i> ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ”¯æ´ï¼ˆAIï¼‰</div>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn-teacher" id="ai-simple-comment-btn">
            <i class="bi bi-chat-dots-fill"></i> AIã‚³ãƒ¡ãƒ³ãƒˆæ¡ˆä½œæˆï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰
          </button>
          <button class="btn-teacher" id="ai-full-feedback-btn">
            <i class="bi bi-stars"></i> AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ¡ˆä½œæˆï¼ˆé«˜åº¦ï¼‰
          </button>
          <button class="btn-teacher" id="batch-return-btn" style="background: linear-gradient(135deg, #43a047, #66bb6a); border-color: #43a047;">
            <i class="bi bi-check2-all"></i> ã‚³ãƒ¡ãƒ³ãƒˆä»˜ãã‚’ä¸€æ‹¬è¿”å´
          </button>
        </div>
      </div>

      <!-- ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ä¸€è¦§ -->
      <div class="giga-card teacher-section">
        <div class="giga-card-title"><i class="bi bi-journal-text"></i> æå‡ºã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ä¸€è¦§</div>
        <div class="filter-bar">
          <label for="student-filter">å…ç«¥:</label>
          <select id="student-filter">
            <option value="all">ã™ã¹ã¦ã®å…ç«¥</option>
            ${rosterOptions}
          </select>
          <label for="date-filter">æ—¥ä»˜:</label>
          <input type="date" id="date-filter">
          <label for="status-filter">çŠ¶æ³:</label>
          <select id="status-filter">
            <option value="all">ã™ã¹ã¦</option>
            <option value="æœªè¿”å´">æœªè¿”å´</option>
            <option value="è¿”å´æ¸ˆã¿">è¿”å´æ¸ˆã¿</option>
          </select>
          <button class="btn-secondary btn-sm" id="filter-reset-btn">
            <i class="bi bi-arrow-counterclockwise"></i> ãƒªã‚»ãƒƒãƒˆ
          </button>
        </div>
        <div style="overflow-x: auto;">
          <table class="journal-table" id="journal-table">
            <thead>
              <tr>
                <th>æ—¥ä»˜</th>
                <th>æ°å</th>
                <th>ãƒ†ãƒ¼ãƒ</th>
                <th>çŠ¶æ³</th>
                <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
              </tr>
            </thead>
            <tbody>
              ${tableRows}
            </tbody>
          </table>
        </div>
      </div>

      <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
      <div class="giga-card teacher-section">
        <div class="giga-card-title"><i class="bi bi-download"></i> ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
        <div class="export-form">
          <div class="export-filters">
            <div class="export-filter-item">
              <label for="export-start-date">é–‹å§‹æ—¥:</label>
              <input type="date" id="export-start-date">
            </div>
            <div class="export-filter-item">
              <label for="export-end-date">çµ‚äº†æ—¥:</label>
              <input type="date" id="export-end-date">
            </div>
            <div class="export-filter-item">
              <label for="export-student">å…ç«¥:</label>
              <select id="export-student">
                <option value="all">ã™ã¹ã¦ã®å…ç«¥</option>
                ${rosterOptions}
              </select>
            </div>
          </div>
          <div class="export-actions">
            <button class="btn-secondary" id="export-csv-btn">
              <i class="bi bi-file-earmark-spreadsheet"></i> CSVå‡ºåŠ›
            </button>
            <button class="btn-teacher" id="export-pdf-btn">
              <i class="bi bi-file-earmark-pdf-fill"></i> PDFå‡ºåŠ›
            </button>
          </div>
          <div id="export-result" class="export-result"></div>
        </div>
      </div>
    </div>

    <!-- ç®¡ç†ç”»é¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ -->
    ${isAdmin ? '<div class="page-section" id="page-admin"><div id="admin-content">èª­ã¿è¾¼ã¿ä¸­...</div></div>' : ''}
  `;

    addTeacherEventListeners();



    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('export-csv-btn').addEventListener('click', () => handleExport('csv'));
    document.getElementById('export-pdf-btn').addEventListener('click', () => handleExport('pdf'));

    // ç®¡ç†ã‚¿ãƒ–ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    if (isAdmin) {
      document.getElementById('tab-dashboard').addEventListener('click', () => {
        document.getElementById('tab-dashboard').classList.add('active');
        document.getElementById('tab-admin').classList.remove('active');
        showPage('page-dashboard');
      });
      document.getElementById('tab-admin').addEventListener('click', () => {
        document.getElementById('tab-admin').classList.add('active');
        document.getElementById('tab-dashboard').classList.remove('active');
        showPage('page-admin');
        renderAdminPanel();
      });
    }
  }

  /** æ•™å¸«ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œã‚’ç”Ÿæˆã™ã‚‹ */
  function renderJournalRow(journal) {
    const statusClass = journal.status === 'è¿”å´æ¸ˆã¿' ? 'status-returned' : 'status-unreturned';
    const d = new Date(journal.timestamp);
    const formattedDate = `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
    const revertBtn = journal.status === 'è¿”å´æ¸ˆã¿'
      ? `<button class="btn-danger revert-status-btn" data-journal-id="${journal.journalId}">è¿”å´ã‚’å–ã‚Šæ¶ˆã™</button>`
      : '';

    // æœªè¿”å´æ™‚ã®ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ³ãƒ—ãƒœã‚¿ãƒ³
    const quickStamps = journal.status !== 'è¿”å´æ¸ˆã¿'
      ? `<span class="quick-stamp-group" data-journal-id="${journal.journalId}">
                 <button class="quick-stamp-btn" data-stamp="ğŸ˜Š" title="ã†ã‚Œã—ã„">ğŸ˜Š</button>
                 <button class="quick-stamp-btn" data-stamp="ğŸ‘" title="ãŒã‚“ã°ã£ãŸ">ğŸ‘</button>
                 <button class="quick-stamp-btn" data-stamp="ğŸ’ª" title="ã¡ã‚‡ã†ã›ã‚“">ğŸ’ª</button>
                 <button class="quick-stamp-btn" data-stamp="â­" title="ã™ã°ã‚‰ã—ã„">â­</button>
               </span>`
      : '';

    return `
    <tr data-journal-id="${journal.journalId}" data-email="${journal.email}"
        data-date="${formattedDate}" data-status="${journal.status}">
      <td>${formattedDate}</td>
      <td>${escapeHtml(journal.studentName)}</td>
      <td>${escapeHtml((journal.theme || '').substring(0, 20))}${(journal.theme || '').length > 20 ? '...' : ''}</td>
      <td><span class="status-badge ${statusClass}">${journal.status}</span></td>
      <td>
        ${quickStamps}
        <button class="btn-teacher btn-sm view-journal-btn" data-journal-id="${journal.journalId}">
          <i class="bi bi-chat-left-text-fill"></i> ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        </button>
        ${revertBtn}
      </td>
    </tr>
  `;
  }

  /** æ•™å¸«ç”»é¢ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹ */
  function addTeacherEventListeners() {
    // ãƒ†ãƒ¼ãƒè¨­å®š
    document.getElementById('set-theme-btn').addEventListener('click', handleSetTheme);

    // é€±é–“ãƒ†ãƒ¼ãƒ
    document.getElementById('save-weekly-themes-btn').addEventListener('click', handleSaveWeeklyThemes);
    loadWeeklyThemes();

    // AIæ©Ÿèƒ½
    document.getElementById('ai-simple-comment-btn').addEventListener('click', handleAiSimpleComment);
    document.getElementById('ai-full-feedback-btn').addEventListener('click', handleAiFullFeedback);

    // ä¸€æ‹¬è¿”å´
    document.getElementById('batch-return-btn').addEventListener('click', handleBatchReturn);

    // ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆå§”ä»»
    document.getElementById('journal-table').addEventListener('click', (e) => {
      const viewBtn = e.target.closest('.view-journal-btn');
      if (viewBtn) {
        const jId = viewBtn.dataset.journalId;
        const journal = journalsData.find(j => j.journalId === jId);
        if (journal) showTeacherJournalModal(journal);
      }

      const revertBtn = e.target.closest('.revert-status-btn');
      if (revertBtn) {
        handleRevertStatus(revertBtn.dataset.journalId);
      }

      // ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ³ãƒ—è¿”å´
      const stampBtn = e.target.closest('.quick-stamp-btn');
      if (stampBtn) {
        const group = stampBtn.closest('.quick-stamp-group');
        const journalId = group.dataset.journalId;
        const stamp = stampBtn.dataset.stamp;
        handleQuickReturn(journalId, stamp);
      }
    });

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    document.getElementById('student-filter').addEventListener('change', filterJournals);
    document.getElementById('date-filter').addEventListener('change', filterJournals);
    document.getElementById('status-filter').addEventListener('change', filterJournals);
    document.getElementById('filter-reset-btn').addEventListener('click', () => {
      document.getElementById('student-filter').value = 'all';
      document.getElementById('date-filter').value = '';
      document.getElementById('status-filter').value = 'all';
      filterJournals();
    });

    // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
    renderTodaySummary();
  }


  // =============================================================
  // â–  8. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
  // =============================================================

  /** ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»ã™ã‚‹ */
  function renderCalendar(year, month) {
    const el = document.getElementById('calendar');
    if (!el) return;

    const journalDates = new Set(
      journalsData.map(j => new Date(j.timestamp).toLocaleDateString('ja-JP'))
    );

    let html = `
    <div class="calendar-header">
      <button class="btn-secondary btn-sm" id="prev-month"><i class="bi bi-chevron-left"></i></button>
      <h3>${year}<ruby>å¹´<rt>ã­ã‚“</rt></ruby> ${month + 1}<ruby>æœˆ<rt>ãŒã¤</rt></ruby></h3>
      <button class="btn-secondary btn-sm" id="next-month"><i class="bi bi-chevron-right"></i></button>
    </div>
    <div class="calendar-grid">
  `;

    ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].forEach(d => {
      html += `<div class="day-name">${d}</div>`;
    });

    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();

    for (let i = 0; i < firstDay; i++) html += '<div></div>';

    for (let i = 1; i <= lastDate; i++) {
      const ds = new Date(year, month, i).toLocaleDateString('ja-JP');
      const has = journalDates.has(ds);
      html += `<div class="calendar-day ${has ? 'has-journal' : ''}" data-date="${ds}">${i}</div>`;
    }

    html += '</div>';
    el.innerHTML = html;

    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    document.getElementById('prev-month').onclick = () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
    };
    document.getElementById('next-month').onclick = () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
    };

    // æ—¥ä»˜ã‚¯ãƒªãƒƒã‚¯
    document.querySelectorAll('.has-journal').forEach(day => {
      day.onclick = (e) => {
        const clickedDate = e.target.dataset.date;
        const matched = journalsData.filter(j =>
          new Date(j.timestamp).toLocaleDateString('ja-JP') === clickedDate
        );
        if (matched.length > 0) showStudentJournalModal(matched, 0, false);
      };
    });
  }


  // =============================================================
  // â–  9. å…ç«¥ç”¨ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
  // =============================================================

  /** ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«æå‡ºå‡¦ç† */
  async function handleSubmit() {
    const content = document.getElementById('journal-content').value;
    if (!content.trim()) {
      Swal.fire({
        icon: 'warning',
        title: '<ruby>å…¥åŠ›<rt>ã«ã‚…ã†ã‚Šã‚‡ã</rt></ruby>ã—ã¦ãã ã•ã„',
        text: 'ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã®æœ¬æ–‡ã‚’æ›¸ã„ã¦ã‹ã‚‰æå‡ºã—ã¦ãã ã•ã„ã€‚',
        confirmButtonText: 'OK'
      });
      return;
    }

    const journalData = {
      email: userData.email,
      theme: todayTheme,
      content: content,
      emotion: selectedEmotion
    };

    try {
      // ç”»åƒãŒã‚ã‚‹å ´åˆã¯å…ˆã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      if (selectedFile) {
        const fileData = await readFileAsBase64(selectedFile);
        const uploadResult = await callGasWithSpinner('uploadImage', fileData);
        if (!uploadResult.success) {
          Swal.fire({ icon: 'error', title: 'ã‚¨ãƒ©ãƒ¼', text: uploadResult.message });
          return;
        }
        journalData.imageFileId = uploadResult.fileId;
      }

      // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ä¿å­˜
      const result = await callGasWithSpinner('saveJournal', journalData);
      if (result.success) {
        await Swal.fire({
          icon: 'success',
          title: '<ruby>æå‡º<rt>ã¦ã„ã—ã‚…ã¤</rt></ruby>ã§ãã¾ã—ãŸï¼',
          text: result.message,
          confirmButtonText: 'OK'
        });
        reloadPage();
      } else {
        Swal.fire({ icon: 'error', title: 'ã‚¨ãƒ©ãƒ¼', text: result.message });
      }
    } catch (e) {
      // callGasWithSpinner å†…ã§ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºæ¸ˆã¿
    }
  }

  /** ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Base64 ã¨ã—ã¦èª­ã¿å–ã‚‹ Promise */
  function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        resolve({
          fileName: file.name,
          mimeType: file.type,
          data: e.target.result.split(',')[1]
        });
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  /** æ°—æŒã¡é¸æŠ */
  function handleEmotionSelect(e) {
    document.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('selected'));
    e.target.classList.add('selected');
    selectedEmotion = e.target.dataset.emotion;
  }

  /** ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ */
  function handleFileSelect(e) {
    selectedFile = e.target.files[0];
    if (selectedFile) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        document.getElementById('preview-area').innerHTML =
          `<img src="${ev.target.result}" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">`;
      };
      reader.readAsDataURL(selectedFile);
    }
  }

  /** ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæŒ¿å…¥ */
  function insertTemplate(type) {
    const ta = document.getElementById('journal-content');
    const templates = {
      ywt: 'ã€Y: ã‚„ã£ãŸã“ã¨ã€‘\n\nã€W: ã‚ã‹ã£ãŸã“ã¨ã€‘\n\nã€T: ã¤ãã«ã‚„ã‚‹ã“ã¨ã€‘\n',
      kpt: 'ã€K: Keep ã‚ˆã‹ã£ãŸã“ã¨ãƒ»ã¤ã¥ã‘ã‚‹ã“ã¨ã€‘\n\nã€P: Problem ã“ã¾ã£ãŸã“ã¨ãƒ»ã‚„ã‚ã‚‹ã“ã¨ã€‘\n\nã€T: Try ã¤ãã«ãŸã‚ã™ã“ã¨ã€‘\n',
      '5w1h': 'ã€ã„ã¤ã€‘\n\nã€ã©ã“ã§ã€‘\n\nã€ã ã‚ŒãŒã€‘\n\nã€ãªã«ã‚’ã€‘\n\nã€ãªãœã€‘\n\nã€ã©ã®ã‚ˆã†ã«ã€‘\n',
      '3notice': 'ã€ã‚ã‹ã£ãŸã“ã¨ã€‘\n\nã€ãŠã©ã‚ã„ãŸã“ã¨ã€‘\n\nã€ã‚‚ã£ã¨ã—ã‚ŠãŸã„ã“ã¨ã€‘\n'
    };
    ta.value += templates[type] || '';
    ta.focus();
    updateCharCounter();
  }

  /** ãƒ©ãƒ³ãƒ€ãƒ æ›¸ãå‡ºã—æ–‡ã‚’æŒ¿å…¥ */
  function insertStarter() {
    const starters = [
      'ä»Šæ—¥ã„ã¡ã°ã‚“å¿ƒã«ã®ã“ã£ãŸã®ã¯ã€',
      'ä»Šæ—¥ã€ã¯ã˜ã‚ã¦ã§ããŸã“ã¨ã¯ã€',
      'ä»Šæ—¥ã†ã‚Œã—ã‹ã£ãŸã®ã¯ã€',
      'ä»Šæ—¥ã¡ã‚‡ã£ã¨ã‚€ãšã‹ã—ã‹ã£ãŸã®ã¯ã€',
      'å‹ã ã¡ã®ã™ã”ã„ãªã¨æ€ã£ãŸã¨ã“ã‚ã¯ã€',
      'ä»Šæ—¥ã®å­¦ã³ã§å¤§åˆ‡ã ã¨æ€ã£ãŸã“ã¨ã¯ã€',
      'ã‚‚ã—ã‚‚ã†ä¸€åº¦ã‚„ã‚‹ãªã‚‰ã€',
      'ä»Šæ—¥ã®è‡ªåˆ†ã«ã²ã¨ã“ã¨è¨€ã†ãªã‚‰ã€',
      'æ˜æ—¥ãŒã‚“ã°ã‚ŠãŸã„ã“ã¨ã¯ã€',
      'ä»Šæ—¥ã€ã€Œãªã‚‹ã»ã©ï¼ã€ã¨æ€ã£ãŸã®ã¯ã€',
      'ä»Šæ—¥ã®ã˜ã‚…ãã‚‡ã†ã§æ°—ã¥ã„ãŸã“ã¨ã¯ã€',
      'ä»Šæ—¥ã€å‹ã ã¡ã¨å”åŠ›ã—ã¦ã§ããŸã“ã¨ã¯ã€'
    ];
    const ta = document.getElementById('journal-content');
    const random = starters[Math.floor(Math.random() * starters.length)];
    ta.value += random;
    ta.focus();
    updateCharCounter();
  }

  /** æ–‡å­—ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–° */
  function updateCharCounter() {
    const ta = document.getElementById('journal-content');
    const counter = document.getElementById('char-counter');
    if (!ta || !counter) return;
    const len = ta.value.length;
    counter.textContent = len + ' æ–‡å­—';
    counter.classList.toggle('active', len > 0);
  }

  /** ãƒ’ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã®é–‹é–‰ãƒˆã‚°ãƒ« */
  function showHint() {
    const panel = document.getElementById('hint-side-panel');
    const btn = document.getElementById('hint-btn');
    const isOpen = panel.classList.toggle('open');
    btn.textContent = isOpen ? 'ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’ã¨ã˜ã‚‹' : 'ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’é–‹ã';
  }

  /** éå»ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’è¡¨ç¤º */
  function showPastJournal() {
    const oneMonthAgo = new Date();
    oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);

    const pastJournals = journalsData.filter(j => new Date(j.timestamp) < oneMonthAgo);
    if (pastJournals.length === 0) {
      Swal.fire({
        icon: 'info',
        title: 'ã¾ã ã‚ã‚Šã¾ã›ã‚“',
        text: '1ãƒ¶æœˆä»¥ä¸Šå‰ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚',
        confirmButtonText: 'OK'
      });
      return;
    }

    const random = pastJournals[Math.floor(Math.random() * pastJournals.length)];
    showStudentJournalModal([random], 0, true);
  }


  // =============================================================
  // â–  10. æ•™å¸«ç”¨ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
  // =============================================================

  /** ãƒ†ãƒ¼ãƒè¨­å®š */
  async function handleSetTheme() {
    const newTheme = document.getElementById('new-theme-input').value;
    if (!newTheme.trim()) {
      Swal.fire({ icon: 'warning', title: 'å…¥åŠ›ãŒå¿…è¦ã§ã™', text: 'ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' });
      return;
    }
    try {
      const result = await callGasWithSpinner('setTodayTheme', newTheme);
      if (result.success) {
        await Swal.fire({ icon: 'success', title: 'è¨­å®šå®Œäº†', text: result.message });
        reloadPage();
      } else {
        Swal.fire({ icon: 'error', title: 'ã‚¨ãƒ©ãƒ¼', text: result.message });
      }
    } catch (e) { /* ã‚¨ãƒ©ãƒ¼ã¯ callGasWithSpinner ã§è¡¨ç¤ºæ¸ˆã¿ */ }
  }

  /** AIã‚·ãƒ³ãƒ—ãƒ«ã‚³ãƒ¡ãƒ³ãƒˆ */
  async function handleAiSimpleComment() {
    const confirm = await Swal.fire({
      title: 'AIã‚³ãƒ¡ãƒ³ãƒˆæ¡ˆã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ',
      html: 'æœªè¿”å´ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã™ã¹ã¦ã«AIã§ã‚³ãƒ¡ãƒ³ãƒˆæ¡ˆã‚’ä½œæˆã—ã¾ã™ã€‚<br>ï¼ˆæ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'ã¯ã„',
      cancelButtonText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
      customClass: { popup: 'teacher-swal' }
    });
    if (!confirm.isConfirmed) return;

    try {
      const result = await callGasWithSpinner('generateAiSimpleCommentsForAll');
      await Swal.fire({ icon: 'success', title: 'å®Œäº†', text: result.message });
      reloadPage();
    } catch (e) { /* ã‚¨ãƒ©ãƒ¼ã¯ callGasWithSpinner ã§è¡¨ç¤ºæ¸ˆã¿ */ }
  }

  /** AIé«˜åº¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
  async function handleAiFullFeedback() {
    const confirm = await Swal.fire({
      title: 'AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ¡ˆã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ',
      html: 'æœªè¿”å´ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã™ã¹ã¦ã«AIã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ¡ˆã‚’ä½œæˆã—ã¾ã™ã€‚<br>ï¼ˆæ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'ã¯ã„',
      cancelButtonText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
      customClass: { popup: 'teacher-swal' }
    });
    if (!confirm.isConfirmed) return;

    try {
      const result = await callGasWithSpinner('generateAiFullFeedbackForAll');
      await Swal.fire({ icon: 'success', title: 'å®Œäº†', text: result.message });
      reloadPage();
    } catch (e) { /* ã‚¨ãƒ©ãƒ¼ã¯ callGasWithSpinner ã§è¡¨ç¤ºæ¸ˆã¿ */ }
  }

  /** ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ä¿å­˜ */
  async function handleSaveFeedback(journalId) {
    const comment = document.getElementById(`teacher-comment-${journalId}`).value;
    const feedbackData = {
      journalId: journalId,
      comment: comment,
      highlights: JSON.stringify(currentHighlights)
    };

    try {
      const result = await callGasWithSpinner('saveFeedback', feedbackData);
      if (result.success) {
        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        const idx = journalsData.findIndex(j => j.journalId === journalId);
        if (idx > -1) {
          journalsData[idx].teacherComment = feedbackData.comment;
          journalsData[idx].highlights = feedbackData.highlights;
          journalsData[idx].status = 'è¿”å´æ¸ˆã¿';
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«UIæ›´æ–°
        const row = document.querySelector(`tr[data-journal-id="${journalId}"]`);
        if (row) {
          const badge = row.querySelector('.status-badge');
          badge.textContent = 'è¿”å´æ¸ˆã¿';
          badge.className = 'status-badge status-returned';
          row.dataset.status = 'è¿”å´æ¸ˆã¿';

          // ã€Œè¿”å´ã‚’å–ã‚Šæ¶ˆã™ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
          const actionCell = row.querySelector('td:last-child');
          if (actionCell && !actionCell.querySelector('.revert-status-btn')) {
            const btn = document.createElement('button');
            btn.className = 'btn-danger revert-status-btn';
            btn.dataset.journalId = journalId;
            btn.textContent = 'è¿”å´ã‚’å–ã‚Šæ¶ˆã™';
            actionCell.appendChild(btn);
          }
        }

        Swal.close(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        const toast = Swal.mixin({
          toast: true, position: 'top-end', showConfirmButton: false, timer: 2500,
          timerProgressBar: true
        });
        toast.fire({ icon: 'success', title: result.message });
      } else {
        Swal.fire({ icon: 'error', title: 'ã‚¨ãƒ©ãƒ¼', text: result.message });
      }
    } catch (e) { /* ã‚¨ãƒ©ãƒ¼ã¯ callGasWithSpinner ã§è¡¨ç¤ºæ¸ˆã¿ */ }
  }

  /** ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° */
  function filterJournals() {
    const emailVal = document.getElementById('student-filter').value;
    const dateVal = document.getElementById('date-filter').value;
    const statusVal = document.getElementById('status-filter').value;

    document.querySelectorAll('#journal-table tbody tr').forEach(row => {
      const matchEmail = (emailVal === 'all' || row.dataset.email === emailVal);
      const matchDate = (!dateVal || row.dataset.date === dateVal.replace(/-/g, '/'));
      const matchStatus = (statusVal === 'all' || row.dataset.status === statusVal);
      row.style.display = (matchEmail && matchDate && matchStatus) ? '' : 'none';
    });
  }

  /** è¿”å´å–æ¶ˆï¼ˆæ¥½è¦³çš„UIæ›´æ–°ï¼‰ */
  async function handleRevertStatus(journalId) {
    const row = document.querySelector(`tr[data-journal-id="${journalId}"]`);
    if (!row) return;

    // æ¥½è¦³çš„ã«UIã‚’å³æ™‚æ›´æ–°
    const badge = row.querySelector('.status-badge');
    badge.textContent = 'æœªè¿”å´';
    badge.className = 'status-badge status-unreturned';
    row.dataset.status = 'æœªè¿”å´';

    const revertBtn = row.querySelector('.revert-status-btn');
    if (revertBtn) revertBtn.remove();

    const idx = journalsData.findIndex(j => j.journalId === journalId);
    if (idx > -1) journalsData[idx].status = 'æœªè¿”å´';

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
    try {
      await callGas('revertJournalStatus', journalId);
      const toast = Swal.mixin({
        toast: true, position: 'top-end', showConfirmButton: false, timer: 2000,
        timerProgressBar: true
      });
      toast.fire({ icon: 'success', title: 'è¿”å´ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ' });
    } catch (e) {
      // å¤±æ•—æ™‚ã¯UIã‚’å…ƒã«æˆ»ã™
      Swal.fire({ icon: 'error', title: 'ã‚¨ãƒ©ãƒ¼', text: 'è¿”å´ã®å–ã‚Šæ¶ˆã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚' });
      badge.textContent = 'è¿”å´æ¸ˆã¿';
      badge.className = 'status-badge status-returned';
      row.dataset.status = 'è¿”å´æ¸ˆã¿';

      const actionCell = row.querySelector('td:last-child');
      if (actionCell && !actionCell.querySelector('.revert-status-btn')) {
        const btn = document.createElement('button');
        btn.className = 'btn-danger revert-status-btn';
        btn.dataset.journalId = journalId;
        btn.textContent = 'è¿”å´ã‚’å–ã‚Šæ¶ˆã™';
        actionCell.appendChild(btn);
      }
      if (idx > -1) journalsData[idx].status = 'è¿”å´æ¸ˆã¿';
    }
  }


  // =============================================================
  // â–  10.5 ã‚¯ã‚¤ãƒƒã‚¯è¿”å´ãƒ»ä¸€æ‹¬è¿”å´ãƒ»é€±é–“ãƒ†ãƒ¼ãƒãƒ»ã‚µãƒãƒªãƒ¼
  // =============================================================

  /** ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ³ãƒ—è¿”å´ */
  async function handleQuickReturn(journalId, stamp) {
    // æ¥½è¦³çš„UIæ›´æ–°
    const row = document.querySelector(`tr[data-journal-id="${journalId}"]`);
    if (row) {
      const badge = row.querySelector('.status-badge');
      badge.textContent = 'è¿”å´æ¸ˆã¿';
      badge.className = 'status-badge status-returned';
      row.dataset.status = 'è¿”å´æ¸ˆã¿';
      const group = row.querySelector('.quick-stamp-group');
      if (group) group.remove();
    }
    const idx = journalsData.findIndex(j => j.journalId === journalId);
    if (idx > -1) journalsData[idx].status = 'è¿”å´æ¸ˆã¿';

    try {
      await callGas('quickReturn', journalId, stamp);
      const toast = Swal.mixin({
        toast: true, position: 'top-end', showConfirmButton: false, timer: 2000,
        timerProgressBar: true
      });
      toast.fire({ icon: 'success', title: `${stamp} ã§è¿”å´ã—ã¾ã—ãŸ` });
      renderTodaySummary();
    } catch (e) {
      Swal.fire({ icon: 'error', title: 'ã‚¨ãƒ©ãƒ¼', text: 'ã‚¯ã‚¤ãƒƒã‚¯è¿”å´ã«å¤±æ•—ã—ã¾ã—ãŸã€‚' });
      // å¤±æ•—æ™‚ã¯ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
      location.reload();
    }
  }

  /** ä¸€æ‹¬è¿”å´ */
  async function handleBatchReturn() {
    const result = await Swal.fire({
      title: 'ã‚³ãƒ¡ãƒ³ãƒˆä»˜ãã‚’ä¸€æ‹¬è¿”å´',
      text: 'AIã‚³ãƒ¡ãƒ³ãƒˆã¾ãŸã¯æ‰‹å‹•ã‚³ãƒ¡ãƒ³ãƒˆãŒä»˜ã„ã¦ã„ã‚‹æœªè¿”å´ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ã™ã¹ã¦è¿”å´æ¸ˆã¿ã«ã—ã¾ã™ã€‚',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'ä¸€æ‹¬è¿”å´ã™ã‚‹',
      cancelButtonText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
    });
    if (!result.isConfirmed) return;

    try {
      const res = await callGasWithSpinner('batchReturnAll');
      if (res.success) {
        Swal.fire({ icon: 'success', title: 'å®Œäº†', text: res.message });
        // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
        const newData = await callGas('getJournalsForTeacher');
        journalsData = newData;
        renderTeacherView();
        addTeacherEventListeners();

      } else {
        Swal.fire({ icon: 'info', title: 'æƒ…å ±', text: res.message });
      }
    } catch (e) {
      Swal.fire({ icon: 'error', title: 'ã‚¨ãƒ©ãƒ¼', text: 'ä¸€æ‹¬è¿”å´ã«å¤±æ•—ã—ã¾ã—ãŸã€‚' });
    }
  }

  /** é€±é–“ãƒ†ãƒ¼ãƒã‚’èª­ã¿è¾¼ã‚€ */
  async function loadWeeklyThemes() {
    try {
      const res = await callGas('getWeeklyThemes');
      if (res.success && res.data) {
        const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
        days.forEach(d => {
          const el = document.getElementById('theme-' + d);
          if (el) el.value = res.data[d] || '';
        });
      }
    } catch (e) {
      console.log('é€±é–“ãƒ†ãƒ¼ãƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
    }
  }

  /** é€±é–“ãƒ†ãƒ¼ãƒã‚’ä¿å­˜ */
  async function handleSaveWeeklyThemes() {
    const themes = {
      mon: document.getElementById('theme-mon').value.trim(),
      tue: document.getElementById('theme-tue').value.trim(),
      wed: document.getElementById('theme-wed').value.trim(),
      thu: document.getElementById('theme-thu').value.trim(),
      fri: document.getElementById('theme-fri').value.trim()
    };
    try {
      const res = await callGasWithSpinner('saveWeeklyThemes', themes);
      if (res.success) {
        Swal.fire({ icon: 'success', title: 'ä¿å­˜ã—ã¾ã—ãŸ', text: res.message, timer: 2000 });
      } else {
        Swal.fire({ icon: 'error', title: 'ã‚¨ãƒ©ãƒ¼', text: res.message });
      }
    } catch (e) {
      Swal.fire({ icon: 'error', title: 'ã‚¨ãƒ©ãƒ¼', text: 'é€±é–“ãƒ†ãƒ¼ãƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚' });
    }
  }

  /** ã‚µãƒãƒªãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æç”» */
  function renderTodaySummary() {
    const container = document.getElementById('summary-content');
    if (!container) return;

    // ä»Šæ—¥ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’é›†è¨ˆ
    const todayStr = new Date().toLocaleDateString('ja-JP');
    const todayJournals = journalsData.filter(j => {
      const d = new Date(j.timestamp);
      return d.toLocaleDateString('ja-JP') === todayStr;
    });

    const totalStudents = classRoster.length;
    const submittedStudents = new Set(todayJournals.map(j => j.email));
    const submittedCount = submittedStudents.size;
    const unreturned = todayJournals.filter(j => j.status === 'æœªè¿”å´').length;
    const returned = todayJournals.filter(j => j.status === 'è¿”å´æ¸ˆã¿').length;
    const pct = totalStudents > 0 ? Math.round((submittedCount / totalStudents) * 100) : 0;

    // æœªæå‡ºè€…å
    const unsubmitted = classRoster.filter(s => !submittedStudents.has(s.email));
    const unsubNames = unsubmitted.map(s => s.name).join(', ') || 'ãªã—';

    container.innerHTML = `
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-value">${submittedCount}/${totalStudents}</div>
          <div class="summary-label">æå‡º</div>
        </div>
        <div class="summary-item">
          <div class="summary-value" style="color: var(--accent-color);">${unreturned}</div>
          <div class="summary-label">æœªè¿”å´</div>
        </div>
        <div class="summary-item">
          <div class="summary-value" style="color: #43a047;">${returned}</div>
          <div class="summary-label">è¿”å´æ¸ˆã¿</div>
        </div>
      </div>
      <div class="summary-progress">
        <div class="summary-progress-bar" style="width: ${pct}%"></div>
      </div>
      ${unsubmitted.length > 0 ? `<div class="summary-alert">âš ï¸ æœªæå‡º: ${escapeHtml(unsubNames)}</div>` : '<div class="summary-alert" style="color:#43a047;">âœ… å…¨å“¡æå‡ºæ¸ˆã¿</div>'}
    `;
  }


  // =============================================================
  // â–  11. ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆSweetAlert2ï¼‰
  // =============================================================

  /** å…ç«¥ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« : ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«è©³ç´° */
  function showStudentJournalModal(journalsOnDate, indexToShow, isPastDialogue = false) {
    const journal = isPastDialogue ? journalsOnDate[0] : journalsOnDate[indexToShow];
    if (!journal) return;

    const imageHtml = journal.imageUrl
      ? `<img src="${journal.imageUrl}" class="journal-image" alt="<ruby>æ·»ä»˜<rt>ã¦ã‚“ã·</rt></ruby><ruby>ç”»åƒ<rt>ãŒãã†</rt></ruby>">`
      : '';

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£æ
    const highlights = (typeof journal.highlights === 'string' && journal.highlights.startsWith('['))
      ? JSON.parse(journal.highlights) : [];
    const contentHtml = renderContentWithHighlights(journal.content, highlights, false);

    // è¿”å´çŠ¶æ³ã«å¿œã˜ãŸã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º
    const teacherComment = journal.status === 'è¿”å´æ¸ˆã¿'
      ? escapeHtml(journal.teacherComment).replace(/\n/g, '<br>')
      : 'ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“';

    // éå»ã¨ã®å¯¾è©±HTML
    let dialogueHtml = '';
    if (isPastDialogue) {
      dialogueHtml = `
      <div class="feedback-section">
        <h4><i class="bi bi-chat-heart-fill"></i> <ruby>ä»Š<rt>ã„ã¾</rt></ruby>ã®<ruby>è‡ªåˆ†<rt>ã˜ã¶ã‚“</rt></ruby>ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚’<ruby>é€<rt>ãŠã</rt></ruby>ã‚ã†</h4>
        <textarea id="past-comment-input" rows="4" class="form-control" style="font-family:var(--font-family);"
          placeholder="1ãƒ¶<ruby>æœˆå‰<rt>ã’ã¤ã¾ãˆ</rt></ruby>ã®<ruby>è‡ªåˆ†<rt>ã˜ã¶ã‚“</rt></ruby>ã¸...">${escapeHtml(journal.pastComment || '')}</textarea>
        <button class="btn-primary-kid btn-sm" style="margin-top:8px;" onclick="savePastComment('${journal.journalId}')">
          <i class="bi bi-send"></i> <ruby>ä¿å­˜<rt>ã»ãã‚“</rt></ruby>ã™ã‚‹
        </button>
      </div>`;
    }

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
    let paginationHtml = '';
    if (!isPastDialogue && journalsOnDate.length > 1) {
      paginationHtml = '<div class="pagination-controls">' +
        journalsOnDate.map((_, i) =>
          `<button class="page-btn ${i === indexToShow ? 'active' : ''}" data-index="${i}">${i + 1}</button>`
        ).join('') +
        '</div>';
    }

    const modalContent = `
    <div class="modal-notebook-container">
      <div class="modal-notebook-page modal-page-left" id="student-journal-page-left">
        <div class="theme-display">
          <strong><ruby>æ—¥ä»˜<rt>ã²ã¥ã‘</rt></ruby>:</strong> ${new Date(journal.timestamp).toLocaleDateString()}<br>
          <strong>ãƒ†ãƒ¼ãƒ:</strong> ${escapeHtml(journal.theme || '')}
        </div>
        <div class="journal-content-display">${contentHtml}</div>
        <div style="margin-top:auto;">
          <div class="emotion-stamps"><strong><ruby>æ°—æŒ<rt>ãã‚‚</rt></ruby>ã¡:</strong> ${escapeHtml(journal.emotion || 'ï¼ˆãˆã‚‰ã‚“ã§ã„ã¾ã›ã‚“ï¼‰')}</div>
          <div style="margin-top:8px;">${imageHtml}</div>
        </div>
      </div>
      <div class="modal-notebook-page">
        ${paginationHtml}
        <div class="feedback-section">
          <h4><i class="bi bi-chat-left-dots-fill"></i> <ruby>å…ˆç”Ÿ<rt>ã›ã‚“ã›ã„</rt></ruby>ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ</h4>
          <p class="teacher-feedback-text">${teacherComment}</p>
        </div>
        <div class="feedback-section">
          <h4><i class="bi bi-arrow-through-heart-fill"></i> <ruby>æœªæ¥<rt>ã¿ã‚‰ã„</rt></ruby>ã®<ruby>è‡ªåˆ†<rt>ã˜ã¶ã‚“</rt></ruby>ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ</h4>
          <p class="teacher-feedback-text">${escapeHtml(journal.pastComment || 'ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“').replace(/\n/g, '<br>')}</p>
        </div>
        ${dialogueHtml}
      </div>
    </div>
  `;

    Swal.fire({
      html: modalContent,
      showConfirmButton: false,
      showCloseButton: true,
      width: '90%',
      customClass: { popup: 'notebook-modal' },
      didOpen: () => {
        // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ
        addStudentHighlightEventListeners(highlights);
        // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
        document.querySelectorAll('.page-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const newIdx = parseInt(e.target.dataset.index, 10);
            Swal.close();
            showStudentJournalModal(journalsOnDate, newIdx, false);
          });
        });
        // ç”»åƒå…¨ç”»é¢è¡¨ç¤º
        document.querySelectorAll('.journal-image').forEach(img => {
          img.addEventListener('click', (e) => showFullscreenImage(e.target.src));
        });
      }
    });
  }

  /** æ•™å¸«ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« : ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å…¥åŠ› */
  function showTeacherJournalModal(journal) {
    activeJournalId = journal.journalId;
    currentHighlights = (typeof journal.highlights === 'string' && journal.highlights.startsWith('['))
      ? JSON.parse(journal.highlights) : [];

    const imageHtml = journal.imageUrl
      ? `<img src="${journal.imageUrl}" class="journal-image" alt="æ·»ä»˜ç”»åƒ">`
      : '';

    const contentHtml = renderContentWithHighlights(journal.content, currentHighlights, true);

    const modalContent = `
    <div class="modal-notebook-container">
      <div class="modal-notebook-page modal-page-left">
        <div class="theme-display">
          <strong>æ—¥ä»˜:</strong> ${journal.date}<br>
          <strong>æ°å:</strong> ${escapeHtml(journal.studentName)}<br>
          <strong>ãƒ†ãƒ¼ãƒ:</strong> ${escapeHtml(journal.theme || '')}
        </div>
        <div class="journal-content-display" id="teacher-journal-content">${contentHtml}</div>
        <div style="margin-top:auto;">
          <div class="emotion-stamps"><strong>æ°—æŒã¡:</strong> ${escapeHtml(journal.emotion || 'ï¼ˆãˆã‚‰ã‚“ã§ã„ã¾ã›ã‚“ï¼‰')}</div>
          <div style="margin-top:8px;">${imageHtml}</div>
        </div>
      </div>
      <div class="modal-notebook-page">
        <h4><i class="bi bi-pencil-square"></i> ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å…¥åŠ›</h4>
        <textarea id="teacher-comment-${journal.journalId}" rows="12"
          class="form-control" style="flex-grow:1; font-family:var(--font-family); font-size:1rem;"
          placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...">${escapeHtml(journal.teacherComment || '')}</textarea>
        <div style="margin-top:12px; text-align:right;">
          <button class="btn-teacher" onclick="handleSaveFeedback('${journal.journalId}')">
            <i class="bi bi-check-circle-fill"></i> ã‚³ãƒ¡ãƒ³ãƒˆã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ä¿å­˜ã—ã¦è¿”å´ã™ã‚‹
          </button>
        </div>
      </div>
    </div>
  `;

    Swal.fire({
      html: modalContent,
      showConfirmButton: false,
      showCloseButton: true,
      width: '90%',
      customClass: { popup: 'notebook-modal teacher-swal' },
      didOpen: () => {
        const contentArea = document.getElementById('teacher-journal-content');
        contentArea.addEventListener('mouseup', handleTextSelection);
        contentArea.addEventListener('click', handleHighlightClick);
        // ç”»åƒå…¨ç”»é¢è¡¨ç¤º
        document.querySelectorAll('.journal-image').forEach(img => {
          img.addEventListener('click', (e) => showFullscreenImage(e.target.src));
        });
      },
      willClose: () => {
        currentHighlights = [];
        activeJournalId = null;
        document.getElementById('selection-popover').style.display = 'none';
        document.getElementById('highlight-editor').style.display = 'none';
      }
    });
  }


  // =============================================================
  // â–  12. éå»ã‚³ãƒ¡ãƒ³ãƒˆä¿å­˜
  // =============================================================

  /** éå»ã®è‡ªåˆ†ã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¿å­˜ã™ã‚‹ */
  async function savePastComment(journalId) {
    const input = document.getElementById('past-comment-input');
    const comment = input ? input.value : '';
    if (!comment.trim()) {
      Swal.fire({
        icon: 'warning',
        title: '<ruby>å…¥åŠ›<rt>ã«ã‚…ã†ã‚Šã‚‡ã</rt></ruby>ã—ã¦ãã ã•ã„',
        text: 'ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„ã€‚',
        confirmButtonText: 'OK'
      });
      return;
    }

    try {
      const result = await callGasWithSpinner('addPastComment', journalId, comment);
      if (result.success) {
        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        const j = journalsData.find(j => j.journalId === journalId);
        if (j) j.pastComment = comment;

        const toast = Swal.mixin({
          toast: true, position: 'top-end', showConfirmButton: false, timer: 2500,
          timerProgressBar: true
        });
        toast.fire({ icon: 'success', title: result.message });
      } else {
        Swal.fire({ icon: 'error', title: 'ã‚¨ãƒ©ãƒ¼', text: result.message });
      }
    } catch (e) { /* ã‚¨ãƒ©ãƒ¼ã¯ callGasWithSpinner ã§è¡¨ç¤ºæ¸ˆã¿ */ }
  }


  // =============================================================
  // â–  13. ç”»åƒå…¨ç”»é¢è¡¨ç¤º
  // =============================================================

  /** ç”»åƒã‚’å…¨ç”»é¢è¡¨ç¤ºã™ã‚‹ */
  function showFullscreenImage(url) {
    const overlay = document.getElementById('fullscreen-image-overlay');
    const img = document.getElementById('fullscreen-image');
    img.src = url;
    overlay.classList.add('show');
  }


  // =============================================================
  // â–  14. ãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½
  // =============================================================

  /** ãƒ†ã‚­ã‚¹ãƒˆé¸æŠæ™‚ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ */
  function handleTextSelection(e) {
    const popover = document.getElementById('selection-popover');
    if (document.getElementById('highlight-editor').style.display === 'block') return;

    const selection = window.getSelection();
    if (!selection.isCollapsed && selection.rangeCount > 0) {
      selectionRange = selection.getRangeAt(0);
      popover.style.left = `${e.clientX}px`;
      popover.style.top = `${e.clientY - 40}px`;
      popover.style.display = 'block';
      document.getElementById('add-highlight-btn').onclick = createHighlight;
    } else {
      popover.style.display = 'none';
    }
  }

  /** ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ä½œæˆã™ã‚‹ */
  function createHighlight() {
    const contentArea = document.getElementById('teacher-journal-content');
    document.getElementById('selection-popover').style.display = 'none';
    if (!selectionRange) return;

    const newHighlight = {
      id: 'hl-' + Date.now(),
      text: selectionRange.toString(),
      comment: '',
      stamp: '',
      startOffset: getCharOffset(contentArea, selectionRange.startContainer, selectionRange.startOffset),
      endOffset: getCharOffset(contentArea, selectionRange.endContainer, selectionRange.endOffset)
    };

    currentHighlights.push(newHighlight);
    redrawTeacherContent();
    showHighlightEditor(newHighlight.id, document.querySelector(`[data-highlight-id="${newHighlight.id}"]`));
  }

  /** ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¯ãƒªãƒƒã‚¯ */
  function handleHighlightClick(e) {
    if (e.target.classList.contains('highlight-marker')) {
      showHighlightEditor(e.target.dataset.highlightId, e.target);
    }
  }

  /** ãƒã‚¤ãƒ©ã‚¤ãƒˆç·¨é›†ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤ºã™ã‚‹ */
  function showHighlightEditor(highlightId, targetEl) {
    const editor = document.getElementById('highlight-editor');
    const hl = currentHighlights.find(h => h.id === highlightId);
    if (!hl) return;

    const rect = targetEl.getBoundingClientRect();
    editor.style.top = `${rect.bottom + 5}px`;
    editor.style.left = `${rect.left}px`;

    const stamps = ['ğŸ˜„', 'ğŸ˜‚', 'ğŸ¤”', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ’¯', 'â¤', 'ğŸ‘', 'ğŸ‰', 'âœ¨', 'ğŸ’ª', 'ğŸŒ±'];
    editor.innerHTML = `
    <textarea id="highlight-comment-input" rows="4" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›...">${hl.comment}</textarea>
    <div class="stamps">
      ${stamps.map(s => `<button class="stamp-btn ${hl.stamp === s ? 'selected' : ''}" data-stamp="${s}">${s}</button>`).join('')}
    </div>
    <div style="margin-top:10px; display:flex; justify-content:space-between;">
      <button class="btn-teacher btn-sm" id="save-highlight-btn">ä¿å­˜</button>
      <button class="btn-danger" id="delete-highlight-btn">å‰Šé™¤</button>
    </div>
  `;
    editor.style.display = 'block';

    document.getElementById('save-highlight-btn').onclick = () => saveHighlight(highlightId);
    document.getElementById('delete-highlight-btn').onclick = () => deleteHighlight(highlightId);

    editor.querySelectorAll('.stamp-btn').forEach(btn => {
      btn.onclick = () => {
        editor.querySelectorAll('.stamp-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
      };
    });
  }

  /** ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ç·¨é›†å†…å®¹ã‚’ä¿å­˜ã™ã‚‹ */
  function saveHighlight(id) {
    const hl = currentHighlights.find(h => h.id === id);
    if (hl) {
      hl.comment = document.getElementById('highlight-comment-input').value;
      const sel = document.querySelector('#highlight-editor .stamp-btn.selected');
      hl.stamp = sel ? sel.dataset.stamp : '';
    }
    document.getElementById('highlight-editor').style.display = 'none';
    redrawTeacherContent();
  }

  /** ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤ã™ã‚‹ */
  function deleteHighlight(id) {
    currentHighlights = currentHighlights.filter(h => h.id !== id);
    document.getElementById('highlight-editor').style.display = 'none';
    redrawTeacherContent();
  }

  /** æ•™å¸«ç”¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å†æç”»ã™ã‚‹ */
  function redrawTeacherContent() {
    const journal = journalsData.find(j => j.journalId === activeJournalId);
    const el = document.getElementById('teacher-journal-content');
    if (journal && el) {
      el.innerHTML = renderContentWithHighlights(journal.content, currentHighlights, true);
    }
  }

  /** ãƒã‚¤ãƒ©ã‚¤ãƒˆä»˜ãHTMLã‚’ç”Ÿæˆã™ã‚‹ */
  function renderContentWithHighlights(content, highlights, isTeacher) {
    let html = '';
    let lastIdx = 0;
    const sorted = [...highlights].sort((a, b) => a.startOffset - b.startOffset);

    sorted.forEach(h => {
      html += escapeHtml(content.substring(lastIdx, h.startOffset));
      const text = escapeHtml(content.substring(h.startOffset, h.endOffset));
      html += `<mark class="highlight-marker" data-highlight-id="${h.id}">${text}</mark>`;
      lastIdx = h.endOffset;
    });
    html += escapeHtml(content.substring(lastIdx));

    return html.replace(/\n/g, '<br>');
  }

  /** å…ç«¥ç”¨ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ */
  function addStudentHighlightEventListeners(highlights) {
    const markers = document.querySelectorAll('#student-journal-page-left .highlight-marker');
    markers.forEach(marker => {
      const hlId = marker.dataset.highlightId;
      const hlData = highlights.find(h => h.id === hlId);
      if (hlData && (hlData.comment || hlData.stamp)) {
        marker.addEventListener('mouseenter', e => showHighlightTooltip(e, hlData));
        marker.addEventListener('mouseleave', hideHighlightTooltip);
        marker.addEventListener('click', e => showHighlightTooltip(e, hlData));
      }
    });

    const leftPage = document.getElementById('student-journal-page-left');
    if (leftPage) {
      leftPage.addEventListener('click', (e) => {
        if (!e.target.classList.contains('highlight-marker')) hideHighlightTooltip();
      }, true);
    }
  }

  /** ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’è¡¨ç¤ºã™ã‚‹ */
  function showHighlightTooltip(event, hl) {
    const tooltip = document.getElementById('highlight-tooltip');
    if (!hl || (!hl.comment && !hl.stamp)) return;

    tooltip.innerHTML = `<span class="stamp">${hl.stamp || ''}</span> ${escapeHtml(hl.comment)}`;
    const rect = event.target.getBoundingClientRect();
    tooltip.style.left = `${rect.left}px`;
    tooltip.style.top = `${rect.bottom + 5}px`;
    tooltip.style.display = 'block';
  }

  /** ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
  function hideHighlightTooltip() {
    document.getElementById('highlight-tooltip').style.display = 'none';
  }


  // =============================================================
  // â–  15. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
  // =============================================================

  /** ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹ */
  function reloadPage() {
    showSpinner();
    google.script.run
      .withSuccessHandler(url => { window.top.location.href = url; })
      .withFailureHandler(err => {
        hideSpinner();
        Swal.fire({ icon: 'error', title: 'ã‚¨ãƒ©ãƒ¼', text: 'ãƒšãƒ¼ã‚¸ã®å†èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚' });
      })
      .getScriptUrl();
  }

  /** ãƒ†ã‚­ã‚¹ãƒˆã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¨ˆç®—ã™ã‚‹ */
  function getCharOffset(container, node, offset) {
    let charCount = 0;
    let found = false;

    function traverse(n) {
      if (found) return;
      if (n === node) {
        charCount += offset;
        found = true;
        return;
      }
      if (n.nodeType === Node.TEXT_NODE) {
        charCount += n.textContent.length;
      } else if (n.nodeType === Node.ELEMENT_NODE && n.tagName !== 'RT') {
        for (let child of n.childNodes) {
          traverse(child);
          if (found) return;
        }
      }
    }
    traverse(container);
    return charCount;
  }

  /** HTML ã‚¨ã‚¹ã‚±ãƒ¼ãƒ— */
  function escapeHtml(str) {
    if (typeof str !== 'string') return '';
    return str.replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m]));
  }


  // =============================================================
  // â–  16. ç®¡ç†ç”»é¢ï¼ˆAdmin Panelï¼‰
  // =============================================================

  let adminPanelLoaded = false;

  /** ç®¡ç†ç”»é¢ã‚’æç”»ã™ã‚‹ */
  async function renderAdminPanel() {
    const container = document.getElementById('admin-content');
    if (!container) return;

    // æ—¢ã«æç”»æ¸ˆã¿ãªã‚‰å†æç”»ã—ãªã„ï¼ˆè¨­å®šä¿å­˜å¾Œã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ãŸã„å ´åˆã¯å¼·åˆ¶æç”»ï¼‰
    if (adminPanelLoaded) return;

    container.innerHTML = '<div style="text-align:center;padding:40px;"><i class="bi bi-arrow-repeat spin-icon"></i> èª­ã¿è¾¼ã¿ä¸­...</div>';

    try {
      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åç°¿ã¨è¨­å®šã‚’ä¸¦è¡Œå–å¾—
      const [rosterResult, settingsResult] = await Promise.all([
        callGas('getRosterAll'),
        callGas('getAdminSettings')
      ]);

      const roster = rosterResult.success ? rosterResult.data : [];
      const settings = settingsResult.success ? settingsResult : {};

      // åç°¿ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆï¼ˆæ‹…ä»»è¡Œã¯å…ˆé ­ã«ã€å…ç«¥è¡Œã¯ã‚¿ãƒ–åŒºåˆ‡ã‚Šï¼‰
      const rosterLines = roster.map(r => {
        if (r.role === 'æ‹…ä»»') return `æ‹…ä»»\t${r.name}\t${r.email}`;
        return `${r.name}\t${r.email}`;
      }).join('\n');

      // APIã‚­ãƒ¼çŠ¶æ…‹è¡¨ç¤º
      const apiKeyStatus = settings.hasApiKey
        ? `<span class="admin-status-ok"><i class="bi bi-check-circle-fill"></i> è¨­å®šæ¸ˆã¿ï¼ˆ${escapeHtml(settings.apiKeyMasked)}ï¼‰</span>`
        : '<span class="admin-status-warn"><i class="bi bi-exclamation-triangle-fill"></i> æœªè¨­å®š</span>';

      container.innerHTML = `
        <!-- â‘  åç°¿ç®¡ç† -->
        <div class="giga-card admin-section">
          <div class="giga-card-title"><i class="bi bi-people-fill"></i> åç°¿ç®¡ç†</div>
          <p class="admin-help">1è¡Œã«1äººãšã¤å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚Excel ã‚„ Sheets ã‹ã‚‰ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã§ãã¾ã™ã€‚</p>
          <div class="admin-format-hint">
            <code>æ°å&lt;Tab&gt;ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</code>ï¼ˆå…ç«¥ï¼‰<br>
            <code>æ‹…ä»»&lt;Tab&gt;æ°å&lt;Tab&gt;ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</code>ï¼ˆæ‹…ä»»ã‚’è¿½åŠ ã™ã‚‹å ´åˆï¼‰
          </div>
          <textarea id="admin-roster-textarea" class="admin-textarea" rows="10"
                    placeholder="å±±ç”°å¤ªéƒ&#9;taro@school.ed.jp&#10;ä½è—¤èŠ±å­&#9;hanako@school.ed.jp">${escapeHtml(rosterLines)}</textarea>
          <div class="admin-actions">
            <span class="admin-count" id="admin-roster-count">${roster.length} ä»¶</span>
            <button class="btn-teacher" id="admin-save-roster-btn">
              <i class="bi bi-save"></i> åç°¿ã‚’ä¿å­˜
            </button>
          </div>
        </div>

        <!-- â‘¡ Gemini APIè¨­å®š -->
        <div class="giga-card admin-section">
          <div class="giga-card-title"><i class="bi bi-key-fill"></i> Gemini API è¨­å®š</div>
          <div class="admin-status-row">ç¾åœ¨ã®çŠ¶æ…‹: ${apiKeyStatus}</div>
          <div class="admin-api-form">
            <input type="password" id="admin-api-key-input" class="admin-input"
                   placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›ï¼ˆä¾‹: AIzaSy...ï¼‰">
            <button class="btn-secondary" id="admin-toggle-key-btn" title="è¡¨ç¤º/éè¡¨ç¤º">
              <i class="bi bi-eye"></i>
            </button>
          </div>
          <div class="admin-actions">
            <button class="btn-secondary" id="admin-test-api-btn">
              <i class="bi bi-play-circle"></i> ãƒ†ã‚¹ãƒˆé€ä¿¡
            </button>
            <button class="btn-teacher" id="admin-save-api-btn" disabled>
              <i class="bi bi-save"></i> APIã‚­ãƒ¼ã‚’ä¿å­˜
            </button>
          </div>
          <div id="admin-api-test-result" class="admin-test-result"></div>
        </div>

        <!-- â‘¢ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ± -->
        <div class="giga-card admin-section">
          <div class="giga-card-title"><i class="bi bi-database-fill"></i> ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±</div>
          <div class="admin-info-grid">
            ${settings.spreadsheetUrl ? `
            <div class="admin-info-item">
              <span class="admin-info-label"><i class="bi bi-table"></i> ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ</span>
              <a href="${settings.spreadsheetUrl}" target="_blank" class="admin-info-link">
                <i class="bi bi-box-arrow-up-right"></i> é–‹ã
              </a>
            </div>` : ''}
            ${settings.imageFolderUrl ? `
            <div class="admin-info-item">
              <span class="admin-info-label"><i class="bi bi-folder-fill"></i> ç”»åƒãƒ•ã‚©ãƒ«ãƒ€</span>
              <a href="${settings.imageFolderUrl}" target="_blank" class="admin-info-link">
                <i class="bi bi-box-arrow-up-right"></i> é–‹ã
              </a>
            </div>` : ''}
          </div>
        </div>

        <!-- â‘£ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ -->
        <div class="giga-card admin-section admin-danger-zone">
          <div class="giga-card-title"><i class="bi bi-exclamation-triangle-fill"></i> ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</div>
          <p class="admin-help">ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
          <button class="btn-danger" id="admin-reset-data-btn">
            <i class="bi bi-trash3-fill"></i> ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å…¨å‰Šé™¤
          </button>
        </div>
      `;

      addAdminEventListeners();
      adminPanelLoaded = true;

    } catch (e) {
      container.innerHTML = '<div class="giga-card"><p>ç®¡ç†ç”»é¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p></div>';
    }
  }

  /** åç°¿ãƒ†ã‚­ã‚¹ãƒˆã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–° */
  function updateRosterCount() {
    const textarea = document.getElementById('admin-roster-textarea');
    const countEl = document.getElementById('admin-roster-count');
    if (!textarea || !countEl) return;

    const lines = textarea.value.split('\n').filter(line => line.trim());
    countEl.textContent = `${lines.length} ä»¶`;
  }

  /** ç®¡ç†ç”»é¢ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹ */
  function addAdminEventListeners() {
    // åç°¿ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚«ã‚¦ãƒ³ãƒˆ
    document.getElementById('admin-roster-textarea').addEventListener('input', updateRosterCount);

    // åç°¿ä¿å­˜
    document.getElementById('admin-save-roster-btn').addEventListener('click', handleSaveRoster);

    // APIã‚­ãƒ¼è¡¨ç¤º/éè¡¨ç¤ºãƒˆã‚°ãƒ«
    document.getElementById('admin-toggle-key-btn').addEventListener('click', () => {
      const input = document.getElementById('admin-api-key-input');
      const icon = document.querySelector('#admin-toggle-key-btn i');
      if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'bi bi-eye-slash';
      } else {
        input.type = 'password';
        icon.className = 'bi bi-eye';
      }
    });

    // APIã‚­ãƒ¼ãƒ†ã‚¹ãƒˆ
    document.getElementById('admin-test-api-btn').addEventListener('click', handleTestApiKey);

    // APIã‚­ãƒ¼ä¿å­˜
    document.getElementById('admin-save-api-btn').addEventListener('click', handleSaveApiKey);

    // ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('admin-reset-data-btn').addEventListener('click', handleResetData);
  }

  /** åç°¿ã‚’ä¸€æ‹¬ä¿å­˜ã™ã‚‹ */
  async function handleSaveRoster() {
    const textarea = document.getElementById('admin-roster-textarea');
    const lines = textarea.value.split('\n').filter(line => line.trim());

    const rows = lines.map(line => {
      const parts = line.split('\t');
      if (parts.length >= 3) {
        // ã€Œæ‹…ä»»<Tab>æ°å<Tab>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€å½¢å¼
        return { role: parts[0].trim(), name: parts[1].trim(), email: parts[2].trim() };
      } else if (parts.length === 2) {
        // ã€Œæ°å<Tab>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€å½¢å¼ â†’ å…ç«¥
        return { role: 'å…ç«¥', name: parts[0].trim(), email: parts[1].trim() };
      } else {
        return null; // ç„¡åŠ¹ãªè¡Œ
      }
    }).filter(r => r && r.name && r.email);

    if (rows.length === 0) {
      Swal.fire({ icon: 'warning', title: 'å…¥åŠ›ãŒå¿…è¦ã§ã™', text: 'æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚' });
      return;
    }

    const confirm = await Swal.fire({
      title: 'åç°¿ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ',
      html: `<b>${rows.length}ä»¶</b>ã®ãƒ‡ãƒ¼ã‚¿ã§åç°¿ã‚’ä¸Šæ›¸ãä¿å­˜ã—ã¾ã™ã€‚`,
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'ä¿å­˜ã™ã‚‹',
      cancelButtonText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
    });
    if (!confirm.isConfirmed) return;

    try {
      const result = await callGasWithSpinner('saveRosterAll', rows);
      if (result.success) {
        Swal.fire({ icon: 'success', title: 'ä¿å­˜å®Œäº†', text: result.message });
      } else {
        Swal.fire({ icon: 'error', title: 'ã‚¨ãƒ©ãƒ¼', text: result.message });
      }
    } catch (e) { /* callGasWithSpinnerå†…ã§ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºæ¸ˆã¿ */ }
  }

  /** APIã‚­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ */
  async function handleTestApiKey() {
    const input = document.getElementById('admin-api-key-input');
    const apiKey = input.value.trim();
    if (!apiKey) {
      Swal.fire({ icon: 'warning', title: 'å…¥åŠ›ãŒå¿…è¦ã§ã™', text: 'APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' });
      return;
    }

    const resultEl = document.getElementById('admin-api-test-result');
    resultEl.innerHTML = '<i class="bi bi-arrow-repeat spin-icon"></i> ãƒ†ã‚¹ãƒˆä¸­...';
    resultEl.className = 'admin-test-result testing';

    try {
      const result = await callGas('testGeminiApiKey', apiKey);
      if (result.success) {
        resultEl.innerHTML = `<i class="bi bi-check-circle-fill"></i> ${escapeHtml(result.message)}`;
        resultEl.className = 'admin-test-result success';
        // ãƒ†ã‚¹ãƒˆæˆåŠŸ â†’ ä¿å­˜ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
        document.getElementById('admin-save-api-btn').disabled = false;
      } else {
        resultEl.innerHTML = `<i class="bi bi-x-circle-fill"></i> ${escapeHtml(result.message)}`;
        resultEl.className = 'admin-test-result error';
        document.getElementById('admin-save-api-btn').disabled = true;
      }
    } catch (e) {
      resultEl.innerHTML = '<i class="bi bi-x-circle-fill"></i> ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
      resultEl.className = 'admin-test-result error';
    }
  }

  /** APIã‚­ãƒ¼ã‚’ä¿å­˜ã™ã‚‹ */
  async function handleSaveApiKey() {
    const apiKey = document.getElementById('admin-api-key-input').value.trim();
    if (!apiKey) return;

    try {
      const result = await callGasWithSpinner('saveAdminSettings', { apiKey: apiKey });
      if (result.success) {
        await Swal.fire({ icon: 'success', title: 'ä¿å­˜å®Œäº†', text: result.message });
        // ç®¡ç†ç”»é¢ã‚’å†æç”»
        adminPanelLoaded = false;
        renderAdminPanel();
      } else {
        Swal.fire({ icon: 'error', title: 'ã‚¨ãƒ©ãƒ¼', text: result.message });
      }
    } catch (e) { /* callGasWithSpinnerå†…ã§ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºæ¸ˆã¿ */ }
  }

  /** ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å…¨å‰Šé™¤ã™ã‚‹ */
  async function handleResetData() {
    const first = await Swal.fire({
      title: 'âš ï¸ æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
      text: 'ã™ã¹ã¦ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'å‰Šé™¤ã™ã‚‹',
      cancelButtonText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
      confirmButtonColor: '#d33'
    });
    if (!first.isConfirmed) return;

    // äºŒé‡ç¢ºèª
    const second = await Swal.fire({
      title: 'æœ€çµ‚ç¢ºèª',
      html: 'æœ¬å½“ã«ã™ã¹ã¦ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’<b>å®Œå…¨ã«å‰Šé™¤</b>ã—ã¾ã™ã‹ï¼Ÿ<br>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚',
      icon: 'error',
      showCancelButton: true,
      confirmButtonText: 'ã¯ã„ã€å‰Šé™¤ã—ã¾ã™',
      cancelButtonText: 'ã‚„ã‚ã‚‹',
      confirmButtonColor: '#d33'
    });
    if (!second.isConfirmed) return;

    try {
      const result = await callGasWithSpinner('resetAllData');
      if (result.success) {
        await Swal.fire({ icon: 'success', title: 'å‰Šé™¤å®Œäº†', text: result.message });
        reloadPage();
      } else {
        Swal.fire({ icon: 'error', title: 'ã‚¨ãƒ©ãƒ¼', text: result.message });
      }
    } catch (e) { /* callGasWithSpinnerå†…ã§ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºæ¸ˆã¿ */ }
  }


  // =============================================================
  // â–  17. ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
  // =============================================================

  /** ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ */
  async function handleExport(format) {
    const startDate = document.getElementById('export-start-date').value;
    const endDate = document.getElementById('export-end-date').value;
    const email = document.getElementById('export-student').value;
    const resultEl = document.getElementById('export-result');

    const params = { startDate, endDate, email };
    const funcName = format === 'csv' ? 'exportJournalsCsv' : 'exportJournalsPdf';
    const formatLabel = format === 'csv' ? 'CSV' : 'PDF';

    resultEl.innerHTML = `<i class="bi bi-arrow-repeat spin-icon"></i> ${formatLabel}ã‚’ç”Ÿæˆä¸­... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„`;
    resultEl.className = 'export-result loading';

    try {
      const result = await callGas(funcName, params);
      if (result.success) {
        resultEl.innerHTML = `
          <i class="bi bi-check-circle-fill"></i> ${escapeHtml(result.message)}
          <a href="${result.fileUrl}" target="_blank" class="export-download-link">
            <i class="bi bi-box-arrow-up-right"></i> ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
          </a>`;
        resultEl.className = 'export-result success';
      } else {
        resultEl.innerHTML = `<i class="bi bi-x-circle-fill"></i> ${escapeHtml(result.message)}`;
        resultEl.className = 'export-result error';
      }
    } catch (e) {
      resultEl.innerHTML = '<i class="bi bi-x-circle-fill"></i> ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
      resultEl.className = 'export-result error';
    }
  }

</script>
